
rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }
    
    // Helper function to check for Super Admin role
    function isSuperAdmin() {
      return exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
             get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    // Helper function to check if user is a dispensary admin (Owner or Staff)
    function isDispensaryAdmin() {
       return exists(/databases/(default)/documents/users/$(request.auth.uid)) &&
              (get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'DispensaryOwner' ||
               get(/databases/(default)/documents/users/$(request.auth.uid)).data.role == 'DispensaryStaff');
    }
    
    // Allow public read access to all files by default
    // This is useful for product images, dispensary type icons, etc.
    // Write access will be restricted by more specific rules below.
    match /{allPaths=**} {
      allow read: if true;
    }
    
    // Restrict writes to specific folders based on user roles and UID.
    
    // Products: Only dispensary admins can upload product images into a folder path that includes their UID.
    match /products/{userId}/{allPaths=**} {
        allow write: if isSignedIn() && request.auth.uid == userId && isDispensaryAdmin();
    }

    // Lab Reports: Only dispensary admins can upload lab reports into a folder path that includes their UID.
    match /lab-reports/{userId}/{allPaths=**} {
        allow write: if isSignedIn() && request.auth.uid == userId && isDispensaryAdmin();
    }
    
    // Sticker Sets: Any authenticated user can upload their own sticker set assets.
    match /stickersets/{userId}/{allPaths=**} {
        allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // Dispensary Type Assets: Only Super Admins can upload icons and images for dispensary types.
    match /dispensary-type-assets/{allPaths=**} {
      allow write: if isSuperAdmin();
    }

  }
}
