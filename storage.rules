rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if the user is a Super Admin
    function isSuperAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    // Default deny all reads and writes
    match /{allPaths=**} {
      allow read, write: if false;
    }

    // Allow public read on dispensary type assets
    match /dispensary-type-assets/{allPaths=**} {
      allow read: if true;
    }

    // Allow SuperAdmins to write to dispensary type assets
    match /dispensary-type-assets/{allPaths=**} {
      allow write: if isSuperAdmin();
    }
    
    // Allow public read on product images
    match /products/{allPaths=**} {
        allow read: if true;
    }

    // Allow authenticated users to write to their own product images folder
    // The path should be like: /products/{userId}/{imageName}
    match /products/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // Allow public read on lab reports
    match /lab-reports/{allPaths=**} {
        allow read: if true;
    }
    
    // Allow authenticated users to write their own lab reports
    match /lab-reports/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Allow public read on sticker set assets
    match /stickersets/{allPaths=**} {
        allow read: if true;
    }
    
    // Allow authenticated users to write to their own sticker set folder
    match /stickersets/{userId}/{allPaths=**} {
      allow write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
