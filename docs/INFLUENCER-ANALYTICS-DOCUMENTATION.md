# Influencer Analytics System Documentation

## Overview

This document covers the deep analytics dashboards and Financial Hub integration added to The Wellness Tree's influencer/affiliate system. These additions provide comprehensive data visualization and financial tracking for both individual influencers and super admin oversight.

## ğŸ“Š Components Added

### 1. Individual Influencer Analytics Dashboard
**Location**: `/dashboard/influencer/analytics`

A comprehensive visual analytics page for influencers to track their performance with charts, metrics, and insights.

#### Features

**Time Range Filtering**
- 7 days
- 30 days
- 90 days
- All time

**Key Metrics Cards**
1. **Total Revenue** (Green)
   - Total order value from referred customers
   - Trending indicator
   
2. **Average Order Value** (Brown)
   - Average cart size per conversion
   - Helps influencers understand customer spending patterns

3. **Conversion Rate** (Blue)
   - Clicks-to-purchases ratio as percentage
   - Industry benchmark comparison

4. **Earnings Per Click** (Purple)
   - Revenue generated per referral click
   - Efficiency metric

**Chart Sections (Tabs)**

1. **Earnings Trend**
   - 30-day area chart with gradient fill
   - Daily earnings aggregation
   - Visual trend identification

2. **Dispensary Split**
   - Pie chart showing top 5 dispensaries by revenue
   - Bar chart with detailed breakdown
   - Color-coded visualization
   - Helps identify which dispensaries convert best

3. **Performance Analysis**
   - Conversion funnel visualization (Clicks â†’ Sales)
   - Top performing days (highest earnings)
   - Recent commission activity table (last 10)

**Export Functionality**
- CSV export of all analytics data
- Includes profile, commissions, and clicks
- Filename includes timestamp

**Data Processing**
- Client-side metric calculations
- Real-time aggregations
- Responsive chart containers for mobile

#### Dependencies
```bash
npm install recharts
```

**Recharts Components Used**:
- AreaChart (earnings trend)
- PieChart (dispensary split)
- BarChart (dispensary comparison)
- ResponsiveContainer (mobile-friendly)

---

### 2. Super Admin Program Analytics
**Location**: `/admin/dashboard/influencers/analytics`

Program-wide analytics dashboard for administrators to monitor the entire influencer ecosystem.

#### Features

**Summary Metrics**
1. **Total Revenue Generated**
   - All revenue from influencer referrals
   - Order count breakdown

2. **Total Commissions Paid**
   - Sum of all commission payouts
   - Percentage of revenue

3. **Active Influencers**
   - Count of approved/active influencers
   - Total influencer base

4. **Average Conversion Rate**
   - Program-wide conversion percentage
   - Benchmark for performance

**Chart Views (Tabs)**

1. **Revenue Tab**
   - Dual-line chart: Revenue vs Commissions
   - Daily tracking over selected time period
   - Identifies trends and patterns

2. **Influencers Tab**
   - Area chart: Influencer growth over time
   - Pie chart: Status distribution (Active, Pending, Suspended)
   - Cumulative growth visualization

3. **Tiers Tab**
   - Dual-axis bar chart
   - Left axis: Influencer count per tier
   - Right axis: Revenue generated per tier
   - Shows tier distribution and performance

4. **Leaderboard Tab**
   - Top 10 performing influencers
   - Medal indicators (ğŸ¥‡ğŸ¥ˆğŸ¥‰)
   - Each entry shows:
     - Display name and tier
     - Total earnings
     - Number of sales
     - Conversion rate
     - Commission rate

**Additional Stats Cards**

1. **ROI Analysis**
   - Revenue generated
   - Commissions paid
   - Net profit
   - ROI percentage

2. **Payout Summary**
   - Pending payouts (weekly)
   - Completed payouts (historical)
   - Next payout amount (Friday)

3. **Program Health**
   - Active influencer rate
   - Average sales per influencer
   - Top tier count (Forest level)

**Export**
- JSON export with all analytics data
- Generated timestamp
- Includes summary and top performers

---

### 3. Financial Hub Integration
**Location**: `/admin/dashboard/financial-hub`

The influencer program is now fully integrated into the existing Financial Hub with dedicated tracking and analysis.

#### Integration Points

**Updated Metrics Interface**
```typescript
interface FinancialMetrics {
  // ... existing metrics
  influencerRevenue: number;      // Revenue generated by program
  influencerCommissions: number;  // Commissions paid out
  influencerROI: number;          // Return on investment %
}
```

**Navigation Addition**
- New "Influencer Program" menu item
- Icon: Users
- Positioned between Dispensaries and Shipping

**Revenue Sources Section**
- Added influencer program bar
- Shows revenue contribution
- Color: Yellow (#FFCD00)
- Percentage of total platform revenue

**Influencer Panel Features**

1. **Key Metrics Row**
   - Revenue Generated (Green card)
   - Commissions Paid (Orange card)
   - Program ROI (Blue card)

2. **Financial Impact Card**
   - Revenue vs commissions breakdown
   - Net contribution calculation
   - Commission rate analysis
   - Percentage of total revenue
   - ROI multiple (e.g., 4.2x return)
   - Visual progress bar

3. **Quick Action Cards**
   - **Manage Influencers**: Navigate to influencer management
   - **Program Analytics**: Deep dive analytics dashboard
   - **Process Payouts**: Handle weekly commission payments

#### Metrics Calculation

**Data Fetching**
```typescript
const influencerCommissionsQuery = query(
  collection(db, 'influencerCommissions'),
  where('createdAt', '>=', Timestamp.fromDate(startDate)),
  orderBy('createdAt', 'desc')
);
```

**Aggregations**
- `influencerRevenue`: Sum of all `orderTotal` from commissions
- `influencerCommissions`: Sum of all `commissionAmount` from commissions
- `influencerROI`: `((revenue - commissions) / commissions) * 100`

**Updated Expense Tracking**
- Total expenses now include influencer commissions
- Affects net profit calculations
- Updated profit margin percentages

---

## ğŸ› ï¸ API Routes

### Individual Analytics Endpoint
**Route**: `/api/influencer/analytics`  
**Method**: POST  
**Auth**: Firebase ID token (Bearer)

**Request Body**:
```json
{
  "timeRange": "7d" | "30d" | "90d" | "all"
}
```

**Response**:
```json
{
  "profile": InfluencerProfile,
  "commissions": InfluencerCommission[],
  "clicks": ReferralClick[],
  "timeRange": string
}
```

**Features**:
- Verifies user owns the influencer profile
- Filters by date range
- Orders by most recent first
- Limits clicks to 1000 for performance

---

### Admin Analytics Endpoint
**Route**: `/api/admin/influencers/analytics`  
**Method**: POST  
**Auth**: Firebase ID token + admin/superadmin role

**Request Body**:
```json
{
  "timeRange": "7d" | "30d" | "90d" | "all"
}
```

**Response**:
```json
{
  "summary": {
    "totalRevenue": number,
    "totalCommissions": number,
    "totalOrders": number,
    "activeInfluencers": number,
    "totalInfluencers": number,
    "avgConversionRate": number,
    "pendingPayouts": number,
    "completedPayouts": number,
    "nextPayoutAmount": number
  },
  "revenueOverTime": Array<{ date: string, revenue: number, commissions: number }>,
  "influencerGrowth": Array<{ date: string, count: number }>,
  "statusDistribution": Array<{ name: string, value: number }>,
  "tierDistribution": Array<{ tier: string, count: number, revenue: number }>,
  "topInfluencers": Array<{
    id: string,
    displayName: string,
    tier: string,
    earnings: number,
    sales: number,
    conversionRate: number,
    commissionRate: number
  }>
}
```

**Aggregations**:
- All influencers and their stats
- Commission totals by date
- Payout summaries
- Click tracking
- Growth metrics (30-day)
- Tier distributions with revenue
- Leaderboard (top 10)

---

## ğŸ“ˆ Data Visualization

### Chart Library: Recharts

**Why Recharts?**
- React-friendly with TypeScript support
- Responsive out of the box
- Beautiful default styling
- Composable chart components
- Small bundle size

**Charts Used**:

1. **AreaChart** - Earnings over time with gradient
```tsx
<AreaChart data={earningsOverTime}>
  <defs>
    <linearGradient id="colorRevenue" x1="0" y1="0" x2="0" y2="1">
      <stop offset="5%" stopColor="#006B3E" stopOpacity={0.8}/>
      <stop offset="95%" stopColor="#006B3E" stopOpacity={0}/>
    </linearGradient>
  </defs>
  <Area type="monotone" dataKey="revenue" stroke="#006B3E" fill="url(#colorRevenue)" />
</AreaChart>
```

2. **PieChart** - Dispensary revenue split
```tsx
<PieChart>
  <Pie
    data={dispensaryBreakdown}
    dataKey="revenue"
    nameKey="name"
    label={(entry) => `${entry.name}: R${entry.revenue.toFixed(2)}`}
  >
    {data.map((entry, index) => (
      <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
    ))}
  </Pie>
</PieChart>
```

3. **BarChart** - Tier distribution
```tsx
<BarChart data={tierDistribution}>
  <XAxis dataKey="tier" />
  <YAxis yAxisId="left" orientation="left" />
  <YAxis yAxisId="right" orientation="right" />
  <Bar yAxisId="left" dataKey="count" fill="#8884d8" />
  <Bar yAxisId="right" dataKey="revenue" fill="#82ca9d" />
</BarChart>
```

4. **LineChart** - Revenue vs commissions trend
```tsx
<LineChart data={revenueOverTime}>
  <Line type="monotone" dataKey="revenue" stroke="#006B3E" strokeWidth={2} />
  <Line type="monotone" dataKey="commissions" stroke="#FF6B35" strokeWidth={2} />
</LineChart>
```

**Color Palette**:
- Primary Green: `#006B3E`
- Brown: `#3D2E17`
- Light Brown: `#5D4E37`
- Medium Brown: `#8B7355`
- Tan: `#A0826D`

---

## ğŸ” Security & Permissions

### Individual Analytics
- **Auth Required**: Yes (Firebase ID token)
- **Permission**: Must own the influencer profile
- **Verification**: Queries `influencers` collection by `userId`
- **Error Handling**: 401 Unauthorized, 404 Not Found

### Admin Analytics
- **Auth Required**: Yes (Firebase ID token)
- **Permission**: Role must be `admin` or `superadmin`
- **Verification**: Checks `users` collection for role
- **Error Handling**: 401 Unauthorized, 403 Forbidden

### Financial Hub
- **Auth Required**: Yes (inherited from admin dashboard)
- **Permission**: Super admin access via AuthContext
- **Navigation Guard**: Admin layout wraps all routes
- **Data Access**: Full visibility to all financial metrics

---

## ğŸ“± Mobile Responsiveness

All analytics dashboards are fully responsive:

**Breakpoints**:
- Mobile: < 768px (1 column)
- Tablet: 768px - 1024px (2 columns)
- Desktop: > 1024px (3-4 columns)

**Chart Adaptations**:
- ResponsiveContainer wraps all charts
- Width: 100% of parent
- Height: Fixed (96 = 384px, responsive to container)
- Labels adjust for smaller screens
- Touch-friendly tooltips

**Card Grid**:
```tsx
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
  {/* Cards */}
</div>
```

---

## ğŸš€ Usage Examples

### Influencer Viewing Their Analytics
1. Navigate to `/dashboard/influencer`
2. Click "Analytics" tab or link
3. Page loads with 30-day default view
4. Select different time range (7d, 90d, all)
5. Explore tabs (Earnings, Breakdown, Performance)
6. Export CSV if needed

### Admin Monitoring Program
1. Navigate to `/admin/dashboard/influencers/analytics`
2. View program-wide summary
3. Check revenue vs commissions trend
4. Review leaderboard for top performers
5. Analyze tier distribution
6. Export JSON report

### Financial Hub Review
1. Navigate to `/admin/dashboard/financial-hub`
2. Click "Influencer Program" in sidebar
3. View revenue generated and ROI
4. Check financial impact metrics
5. Click "View Full Analytics" for deep dive
6. Or click "Manage Influencers" for admin panel

---

## ğŸ¨ UI/UX Design

### Design Principles
1. **Consistency**: Matches existing Wellness Tree design
2. **Clarity**: Clear labels and descriptions
3. **Hierarchy**: Important metrics prominent
4. **Actionability**: Quick action buttons for common tasks
5. **Feedback**: Loading states, success/error toasts

### Color Coding
- **Green**: Positive metrics (revenue, growth)
- **Orange/Red**: Expenses, costs
- **Blue**: Neutral metrics (conversion, engagement)
- **Purple**: Efficiency metrics (EPC, ROI)
- **Yellow**: Influencer-specific branding

### Typography
- **Headers**: 3xl/4xl font, extrabold
- **Metrics**: 2xl/3xl font, bold
- **Labels**: sm font, medium weight
- **Descriptions**: sm/base font, muted color

### Card Styling
```tsx
<Card className="border-2 border-green-200 bg-gradient-to-br from-green-50 to-white">
```
- 2px border for emphasis
- Gradient backgrounds
- Shadow on hover for interactivity
- Rounded corners (default from shadcn)

---

## ğŸ§ª Testing Recommendations

### Unit Tests
1. **Metric Calculations**
   - Test `calculateMetrics()` function
   - Verify ROI calculations
   - Test edge cases (zero revenue, zero commissions)

2. **Data Transformations**
   - Test `earningsOverTime` aggregation
   - Verify date formatting
   - Test dispensary grouping logic

3. **API Routes**
   - Mock Firestore queries
   - Test auth verification
   - Test time range filtering
   - Verify aggregation correctness

### Integration Tests
1. **Influencer Dashboard**
   - Load page with test data
   - Verify charts render
   - Test time range switching
   - Test CSV export functionality

2. **Admin Analytics**
   - Load with multiple influencers
   - Verify leaderboard sorting
   - Test tier distribution accuracy
   - Test empty state handling

3. **Financial Hub**
   - Verify metric integration
   - Test navigation to analytics
   - Verify revenue source percentages
   - Test quick action cards

### E2E Tests
1. Complete user flow: Influencer views analytics
2. Admin reviews program performance
3. Export and download reports
4. Mobile responsiveness check

---

## ğŸ› Troubleshooting

### Charts Not Rendering
**Issue**: Blank space where charts should appear  
**Causes**:
1. Recharts not installed
2. Data not loaded yet
3. Data structure mismatch

**Solutions**:
```bash
npm install recharts
```
Check console for errors. Verify data structure matches chart requirements.

---

### 401 Unauthorized Error
**Issue**: Can't access analytics API  
**Causes**:
1. Not logged in
2. Invalid auth token
3. Token expired

**Solutions**:
- Verify `currentUser` exists in AuthContext
- Check Firebase token is being sent in header
- Try logging out and back in

---

### No Data Showing
**Issue**: Empty states or zero metrics  
**Causes**:
1. No commissions in time range
2. Influencer profile not found
3. Wrong date filtering

**Solutions**:
- Check time range setting (try "All Time")
- Verify influencer profile exists in Firestore
- Check browser console for API errors
- Verify commission records exist

---

### Performance Issues
**Issue**: Slow page load or laggy charts  
**Causes**:
1. Too many data points
2. Large dataset processing
3. Inefficient queries

**Solutions**:
- Limit data fetching (e.g., max 1000 records)
- Use Firestore composite indexes
- Implement pagination for large datasets
- Add loading skeletons

---

## ğŸ“¦ File Structure

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â””â”€â”€ influencer/
â”‚   â”‚       â”œâ”€â”€ page.tsx                    # Main dashboard
â”‚   â”‚       â”œâ”€â”€ analytics/
â”‚   â”‚       â”‚   â””â”€â”€ page.tsx                # Individual analytics âœ¨ NEW
â”‚   â”‚       â””â”€â”€ apply/
â”‚   â”‚           â””â”€â”€ page.tsx                # Application form
â”‚   â”‚
â”‚   â”œâ”€â”€ admin/
â”‚   â”‚   â””â”€â”€ dashboard/
â”‚   â”‚       â”œâ”€â”€ influencers/
â”‚   â”‚       â”‚   â”œâ”€â”€ page.tsx                # Admin management
â”‚   â”‚       â”‚   â””â”€â”€ analytics/
â”‚   â”‚       â”‚       â””â”€â”€ page.tsx            # Program analytics âœ¨ NEW
â”‚   â”‚       â”‚
â”‚   â”‚       â””â”€â”€ financial-hub/
â”‚   â”‚           â””â”€â”€ page.tsx                # Financial Hub (updated) âœ¨
â”‚   â”‚
â”‚   â””â”€â”€ api/
â”‚       â”œâ”€â”€ influencer/
â”‚       â”‚   â”œâ”€â”€ analytics/
â”‚       â”‚   â”‚   â””â”€â”€ route.ts                # Individual analytics API âœ¨ NEW
â”‚       â”‚   â”œâ”€â”€ track-click/
â”‚       â”‚   â”œâ”€â”€ profile/
â”‚       â”‚   â””â”€â”€ apply/
â”‚       â”‚
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ influencers/
â”‚               â”œâ”€â”€ route.ts
â”‚               â”œâ”€â”€ action/
â”‚               â””â”€â”€ analytics/
â”‚                   â””â”€â”€ route.ts            # Admin analytics API âœ¨ NEW
â”‚
â”œâ”€â”€ contexts/
â”‚   â””â”€â”€ ReferralContext.tsx                 # Referral tracking context
â”‚
â””â”€â”€ types/
    â””â”€â”€ influencer.ts                       # TypeScript interfaces
```

---

## ğŸ”„ Data Flow

### Influencer Analytics Flow
```
User navigates to /dashboard/influencer/analytics
â†“
Page loads, useEffect triggers fetchAnalyticsData()
â†“
POST request to /api/influencer/analytics with timeRange
â†“
API verifies auth, fetches profile, commissions, clicks
â†“
Returns data filtered by date range
â†“
Client-side calculateMetrics() processes data
â†“
Charts and metrics rendered with Recharts
â†“
User can switch time range, triggering re-fetch
```

### Admin Analytics Flow
```
Admin navigates to /admin/dashboard/influencers/analytics
â†“
Page loads, useEffect triggers fetchAnalytics()
â†“
POST request to /api/admin/influencers/analytics
â†“
API verifies admin role
â†“
Aggregates data from all influencers, commissions, payouts
â†“
Calculates program-wide metrics
â†“
Returns summary, trends, leaderboard
â†“
Charts and metrics rendered
```

### Financial Hub Flow
```
Admin navigates to /admin/dashboard/financial-hub
â†“
loadFinancialData() runs in useEffect
â†“
Fetches orders, credits, fees, AND influencer commissions
â†“
Aggregates influencerRevenue, influencerCommissions
â†“
Calculates influencerROI
â†“
Updates metrics state with all financial data
â†“
Influencer section renders with program metrics
```

---

## ğŸ¯ Key Metrics Explained

### For Influencers

**Total Revenue**
- Sum of all order totals from referred customers
- Not the commission earned, but the sales generated
- Shows the influencer's total business impact

**Average Order Value (AOV)**
- `totalRevenue / numberOfOrders`
- Indicates quality of referred customers
- Higher AOV = customers buy more per transaction

**Conversion Rate**
- `(numberOfOrders / numberOfClicks) * 100`
- Percentage of clicks that become purchases
- Industry average: 1-3%
- Top performers: 5%+

**Earnings Per Click (EPC)**
- `totalCommissions / numberOfClicks`
- Revenue generated per referral link click
- Efficiency metric combining conversion + AOV
- Higher EPC = more effective marketing

### For Admins

**Active Influencers**
- Count of approved influencers with `status: 'approved'`
- Excludes pending, rejected, suspended

**Avg Conversion Rate**
- `(totalOrders / totalClicks) * 100`
- Program-wide conversion percentage
- Benchmark for individual performance

**Program ROI**
- `((revenue - commissions) / commissions) * 100`
- Return on investment percentage
- Example: 350% ROI = R3.50 earned per R1.00 paid
- Target: 200%+ (2x return)

**ROI Multiple**
- `revenue / commissions`
- Simple ratio (e.g., 4.2x)
- Same as ROI but more intuitive
- Shows how many times investment is returned

---

## ğŸ”® Future Enhancements

### Short Term (Next Sprint)
1. **Real-time Updates**
   - WebSocket for live metrics
   - Push notifications for new sales
   - Auto-refresh dashboard every 5 minutes

2. **Advanced Filters**
   - Filter by dispensary
   - Filter by product category
   - Filter by customer type (new vs returning)

3. **Comparison Views**
   - Month-over-month comparison
   - Year-over-year growth
   - Compare against program average

4. **Email Reports**
   - Weekly performance summaries
   - Monthly statements
   - Automated PDF generation

### Medium Term (Next Month)
1. **Predictive Analytics**
   - Revenue forecasting
   - Trend predictions
   - Goal tracking and projections

2. **A/B Testing Insights**
   - Track different marketing approaches
   - Compare performance by channel
   - Optimize referral strategies

3. **Custom Dashboards**
   - Drag-and-drop widgets
   - Save preferred views
   - Custom date ranges

4. **Mobile App**
   - Native iOS/Android apps
   - Push notifications
   - Quick glance metrics

### Long Term (Next Quarter)
1. **AI Insights**
   - Automated performance recommendations
   - Anomaly detection
   - Personalized tips for improvement

2. **Social Media Integration**
   - Auto-post performance milestones
   - Share earnings achievements
   - Track social media referrals

3. **Advanced Segmentation**
   - Customer lifetime value tracking
   - Cohort analysis
   - Retention metrics

4. **API for Third Parties**
   - Webhook endpoints
   - External dashboard integration
   - Data export API

---

## ğŸ“‹ Deployment Checklist

### Pre-Deployment
- [ ] Run `npm install recharts`
- [ ] Verify all TypeScript compiles without errors
- [ ] Test on local development server
- [ ] Check mobile responsiveness (Chrome DevTools)
- [ ] Verify auth flows (login, role checks)
- [ ] Test with sample data
- [ ] Review console for errors/warnings

### Firestore Setup
- [ ] Ensure composite indexes exist (handled by existing influencer system)
- [ ] Verify `influencerCommissions` collection has data
- [ ] Check `referralClicks` collection structure
- [ ] Confirm `influencers` collection accessible

### Firebase Functions
- [ ] No new functions needed (uses existing collections)
- [ ] Verify existing functions deployed
- [ ] Check function logs for errors

### Environment Variables
- [ ] No new env variables required
- [ ] Verify existing Firebase config

### Post-Deployment
- [ ] Test analytics page loads for influencer user
- [ ] Test admin analytics with superadmin account
- [ ] Verify Financial Hub shows influencer metrics
- [ ] Check all charts render correctly
- [ ] Test CSV/JSON export functionality
- [ ] Monitor Firebase usage (reads/writes)
- [ ] Check performance metrics
- [ ] Review error logs

### Rollback Plan
If issues occur:
1. Revert Financial Hub changes (keep old version)
2. Remove analytics routes from navigation
3. Keep API routes (no harm if unused)
4. Fix issues in development
5. Redeploy when ready

---

## ğŸ“š Related Documentation

- [INFLUENCER-SYSTEM-DOCUMENTATION.md](./INFLUENCER-SYSTEM-DOCUMENTATION.md) - Core system
- [INFLUENCER-DEPLOYMENT.md](./INFLUENCER-DEPLOYMENT.md) - Deployment guide
- [INFLUENCER-IMPLEMENTATION-SUMMARY.md](./INFLUENCER-IMPLEMENTATION-SUMMARY.md) - Implementation summary
- [FINANCIAL-HUB-DOCUMENTATION.md](./FINANCIAL-HUB-DOCUMENTATION.md) - Financial Hub guide

---

## ğŸ¤ Support

For questions or issues:
1. Check this documentation first
2. Review browser console for errors
3. Check Firebase console logs
4. Review Firestore data structure
5. Test with different time ranges
6. Verify auth tokens

Common issues are documented in the Troubleshooting section above.

---

**Last Updated**: January 2025  
**Version**: 1.0.0  
**Status**: Production Ready âœ…
