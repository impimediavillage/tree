
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function isSuperAdmin() {
      return request.auth.token.role == 'SuperAdmin';
    }

    function isOwnerOf(docId) {
      return request.auth.uid == docId;
    }
    
    function isDispensaryOwner() {
      return request.auth.token.role == 'DispensaryOwner';
    }

    // Rules for 'users' collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if isOwnerOf(userId) || isSuperAdmin();
    }

    // Rules for 'dispensaries' collection
    match /dispensaries/{dispensaryId} {
      allow read: if true; // Publicly readable
      allow create: if isAuthenticated(); // Any authenticated user can apply
      allow update, delete: if isSuperAdmin() || (isDispensaryOwner() && request.auth.token.dispensaryId == dispensaryId);
    }

    // Rules for 'dispensaryTypes' collection
    match /dispensaryTypes/{typeId} {
      allow read: if true; // Publicly readable
      allow write: if isSuperAdmin();
    }

    // Rules for 'products' collection
    match /products/{productId} {
      allow read: if true; // Products are public
      allow create, update, delete: if isDispensaryOwner() && get(/databases/$(database)/documents/products/$(productId)).data.dispensaryId == request.auth.token.dispensaryId;
    }

    // Rules for 'productRequests' collection
    match /productRequests/{requestId} {
      allow read, create: if isDispensaryOwner();
      allow update, delete: if isDispensaryOwner() && (get(/databases/$(database)/documents/productRequests/$(requestId)).data.requesterDispensaryId == request.auth.token.dispensaryId || get(/databases/$(database)/documents/productRequests/$(requestId)).data.productOwnerDispensaryId == request.auth.token.dispensaryId);
    }

    // Rules for 'poolIssues' collection
    match /poolIssues/{issueId} {
      allow create: if isDispensaryOwner();
      allow read, update, delete: if isSuperAdmin();
    }
    
    // Rules for 'aiInteractionsLog' collection
    match /aiInteractionsLog/{logId} {
      allow read: if isOwnerOf(get(/databases/$(database)/documents/aiInteractionsLog/$(logId)).data.userId) || isSuperAdmin();
      allow create: if isAuthenticated();
    }
    
    // Rules for 'creditPackages' collection
    match /creditPackages/{packageId} {
      allow read: if true; // Publicly readable
      allow write: if isSuperAdmin();
    }

    // Rules for 'notifications' collection
    match /notifications/{notificationId} {
      allow read, update, delete: if isOwnerOf(get(/databases/$(database)/documents/notifications/$(notificationId)).data.recipientUid);
      allow create: if isDispensaryOwner() || isSuperAdmin(); // Functions create these
    }
    
    // Rules for 'dispensaryTypeProductCategories' collection
    match /dispensaryTypeProductCategories/{categoryId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }

    // Rules for the seeded strain data collection
    match /my-seeded-collection/{strainId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin(); // Only super admins can write to it
    }

  }
}
