
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    function isDispensaryOwner() {
      return request.auth.token.role == 'DispensaryOwner';
    }

    function isOwnerOfDispensary(dispensaryId) {
      return isDispensaryOwner() && request.auth.token.dispensaryId == dispensaryId;
    }

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwnerOfDoc(doc) {
      return request.auth.uid == doc.ownerId;
    }

    // Users Collection
    match /users/{userId} {
      // A user can read/update their own profile.
      // A Super Admin can read/write any user profile.
      allow read, update: if isSuperAdmin() || request.auth.uid == userId;
      // Super Admins can create or delete users (typically done via Admin SDK in functions).
      allow create, delete: if isSuperAdmin();
    }
    
    // Dispensary Types Collection
    match /dispensaryTypes/{typeId} {
        // Anyone can read the types of dispensaries.
        allow read: if true;
        // Only Super Admins can create, update, or delete types.
        allow write: if isSuperAdmin();
    }
    
    // Dispensary Product Categories Collection
    match /dispensaryTypeProductCategories/{docId} {
        // Any authenticated user can read this to build dynamic forms.
        allow read: if isSignedIn();
        // Only Super Admins can write to this collection.
        allow write: if isSuperAdmin();
    }
    
    // Dispensaries Collection
    match /dispensaries/{dispensaryId} {
      // Allow anyone to create a dispensary application.
      allow create: if true;
      // Allow anyone to read an approved dispensary profile.
      // An owner can read their own dispensary profile, regardless of status.
      // A Super Admin can read any dispensary profile.
      allow read: if isSuperAdmin() || resource.data.status == 'Approved' || (isSignedIn() && isOwnerOfDoc(resource.data));
      // An owner can update their own dispensary. A Super Admin can update any.
      allow update: if isSuperAdmin() || (isSignedIn() && isOwnerOfDoc(resource.data));
      // Only Super Admins can delete dispensaries.
      allow delete: if isSuperAdmin();
    }
    
    // Products Collection
    match /products/{productId} {
      // Anyone can read a product if its owning dispensary is approved.
      // We check this by getting the dispensary document.
      allow read: if get(/databases/$(database)/documents/dispensaries/$(resource.data.dispensaryId)).data.status == 'Approved';
      // An owner can create, update, and delete products for their own dispensary.
      // Super Admins have full write access.
      allow write: if isSuperAdmin() || (isOwnerOfDispensary(request.resource.data.dispensaryId));
    }
    
    // Product Requests Collection (for sharing pool)
    match /productRequests/{requestId} {
      // Only involved parties or an admin can read/update a request.
      allow read, update: if isSuperAdmin() || 
                           (isSignedIn() && (isOwnerOfDispensary(resource.data.requesterDispensaryId) || isOwnerOfDispensary(resource.data.productOwnerDispensaryId)));
      // Any authenticated user can create a request.
      allow create: if isSignedIn();
      // Only an admin can delete requests.
      allow delete: if isSuperAdmin();
    }

    // Notifications Collection
    match /notifications/{notificationId} {
      // Only the recipient or a super admin can read/update/delete notifications.
      allow read, update, delete: if isSuperAdmin() || (isSignedIn() && request.auth.uid == resource.data.recipientUid);
      // Only backend functions should create notifications.
      allow create: if isSuperAdmin();
    }

    // Credit Packages Collection
    match /creditPackages/{packageId} {
      // Anyone can read active credit packages. Admins can read all.
      allow read: if isSuperAdmin() || resource.data.isActive == true;
      // Only Super Admins can create/update/delete packages.
      allow write: if isSuperAdmin();
    }
    
    // Other Collections
    match /scrapeLogs/{logId} { allow read, write: if isSuperAdmin(); }
    match /importsHistory/{historyId} { allow read, write: if isSuperAdmin(); }
    match /justbrand_catalog/{catId}/{document=**} { allow read, write: if isSuperAdmin(); }
    match /my-seeded-collection/{strainId} { allow read, write: if isSuperAdmin(); }
    match /poolIssues/{issueId} { allow read, write: if isSuperAdmin(); }
    match /aiInteractionsLog/{logId} { allow read, write: if isSuperAdmin(); }
    match /stickersets/{setId} { 
      allow read: if resource.data.isPublic == true || (isSignedIn() && request.auth.uid == resource.data.creatorUid);
      allow create: if isSignedIn();
      allow update, delete: if isSignedIn() && request.auth.uid == resource.data.creatorUid;
    }
  }
}
