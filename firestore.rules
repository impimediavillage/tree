
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is a super admin
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    // Helper function to check if a user is part of a specific dispensary
    function isDispensaryMember(dispensaryId) {
      return request.auth.token.dispensaryId == dispensaryId && 
             (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff');
    }
    
    // Helper function to check if the user is the document owner
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Users collection rules
    match /users/{userId} {
      // Anyone can create their own user document (on signup)
      allow create: if request.auth.uid == userId;
      // Users can read their own profile. Super Admins can read any profile.
      // Dispensary Owners can read profiles of users linked to their dispensary.
      allow read: if isOwner(userId) || isSuperAdmin() || isDispensaryMember(resource.data.dispensaryId);
      // Users can update their own profile. Super Admins can update any.
      // Dispensary owners can update their staff/linked users, but cannot change role to Super Admin.
      allow update: if isOwner(userId) || 
                       (isSuperAdmin() && request.resource.data.role != 'Super Admin') ||
                       (isDispensaryMember(resource.data.dispensaryId) && request.resource.data.role != 'Super Admin');
      // Only Super Admins can delete users
      allow delete: if isSuperAdmin();
    }

    // Dispensaries collection rules
    match /dispensaries/{dispensaryId} {
      // Anyone can create a dispensary (application process)
      allow create: if request.auth != null;
      // Anyone can read approved dispensary profiles
      allow read: if resource.data.status == 'Approved' || isSuperAdmin() || isDispensaryMember(dispensaryId);
      // Only Super Admins or members of that dispensary can update it
      allow update: if isSuperAdmin() || isDispensaryMember(dispensaryId);
      // Only Super Admins can delete dispensaries
      allow delete: if isSuperAdmin();
    }
    
    // Dispensary Types collection rules
    match /dispensaryTypes/{typeId} {
      // Publicly readable
      allow read: if true;
      // Only Super Admins can create, update, or delete
      allow write: if isSuperAdmin();
    }
    
    // Dispensary Type Product Categories
    match /dispensaryTypeProductCategories/{docId} {
      // Publicly readable for product forms
      allow read: if true;
      // Only Super Admins can manage categories
      allow write: if isSuperAdmin();
    }

    // Products collection rules
    match /products/{productId} {
      // Dispensary members can create products for their own dispensary
      allow create: if isDispensaryMember(request.resource.data.dispensaryId);
      // Anyone can read any product
      allow read: if true;
      // Only members of the product's dispensary can update it
      allow update: if isDispensaryMember(resource.data.dispensaryId);
      // Only members of the product's dispensary or a Super Admin can delete it
      allow delete: if isDispensaryMember(resource.data.dispensaryId) || isSuperAdmin();
    }
    
    // Sticker Sets collection rules
    match /stickersets/{setId} {
      // Logged-in users can create their own sticker sets
      allow create: if isOwner(request.resource.data.creatorUid);
      // Public sets are readable by anyone, private sets only by the creator or admin
      allow read: if resource.data.isPublic == true || isOwner(resource.data.creatorUid) || isSuperAdmin();
      // Only the creator or an admin can update (e.g., toggle public status)
      allow update: if isOwner(resource.data.creatorUid) || isSuperAdmin();
      // Only the creator or an admin can delete
      allow delete: if isOwner(resource.data.creatorUid) || isSuperAdmin();
    }

    // Product Requests rules
    match /productRequests/{requestId} {
        // Logged-in dispensary members can create requests
        allow create: if isDispensaryMember(request.resource.data.requesterDispensaryId);
        // Only involved parties or a super admin can read/update
        allow read, update: if isDispensaryMember(resource.data.requesterDispensaryId) || 
                               isDispensaryMember(resource.data.productOwnerDispensaryId) ||
                               isSuperAdmin();
        // No one can delete requests to maintain history, they can be cancelled instead
        allow delete: if false;
    }

    // AI Interaction Log rules
    match /aiInteractionsLog/{logId} {
      // The user themselves or an admin can read their logs
      allow read: if isOwner(resource.data.userId) || isSuperAdmin() || isDispensaryMember(resource.data.dispensaryId);
      // Only backend functions can create logs
      allow write: if false;
    }
    
    // Credit Packages rules
    match /creditPackages/{packageId} {
      // Anyone can read active packages
      allow read: if resource.data.isActive == true || isSuperAdmin();
      // Only admins can create/update/delete packages
      allow write: if isSuperAdmin();
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
