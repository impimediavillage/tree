
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if a user is a Super Admin
    function isSuperAdmin(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)) &&
             get(/databases/$(database)/documents/users/$(userId)).data.role == 'Super Admin';
    }

    // Helper function to check if a user is a dispensary owner or staff for a specific dispensary
    function isDispensaryAdmin(userId, dispensaryId) {
        return exists(/databases/$(database)/documents/users/$(userId)) &&
               get(/databases/$(database)/documents/users/$(userId)).data.dispensaryId == dispensaryId &&
               (get(/databases/$(database)/documents/users/$(userId)).data.role == 'DispensaryOwner' ||
                get(/databases/$(database)/documents/users/$(userId)).data.role == 'DispensaryStaff');
    }

    // USERS
    match /users/{userId} {
      // A user can always read their own profile.
      // A Super Admin can read any profile.
      // A Dispensary Owner/Staff can read profiles of users associated with their dispensary.
      allow read: if request.auth.uid == userId ||
                     isSuperAdmin(request.auth.uid) ||
                     (isDispensaryAdmin(request.auth.uid, resource.data.dispensaryId));
      
      // A user can update their own profile.
      // A Super Admin can update any profile.
      // A Dispensary Owner can update staff/leaf users linked to their dispensary.
      allow write: if request.auth.uid == userId || 
                      isSuperAdmin(request.auth.uid) ||
                      (isDispensaryAdmin(request.auth.uid, resource.data.dispensaryId) &&
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'DispensaryOwner');
                       
      // Super Admins can list all users. Dispensary admins can list their own users.
      allow list: if isSuperAdmin(request.auth.uid) ||
                     (request.auth.token.dispensaryId != null && 
                      request.query.where.path == "dispensaryId" && 
                      request.query.where.op == "==" && 
                      request.query.where.value == request.auth.token.dispensaryId);
    }

    // DISPENSARIES
    match /dispensaries/{dispensaryId} {
      // Anyone can read an approved dispensary profile.
      // Super Admins and the dispensary's own admin can read it regardless of status.
      allow read: if resource.data.status == 'Approved' ||
                     isSuperAdmin(request.auth.uid) ||
                     isDispensaryAdmin(request.auth.uid, dispensaryId);

      // Anyone can list approved dispensaries.
      // Super Admins can list all dispensaries.
      allow list: if (request.query.where.path == "status" && request.query.where.op == "==" && request.query.where.value == "Approved") ||
                     isSuperAdmin(request.auth.uid);
                     
      // Super Admins can create dispensaries.
      allow create: if isSuperAdmin(request.auth.uid);
      
      // Super Admins or the dispensary's own owner/staff can update.
      allow update: if isSuperAdmin(request.auth.uid) || isDispensaryAdmin(request.auth.uid, dispensaryId);
      
      // Only Super Admins can delete.
      allow delete: if isSuperAdmin(request.auth.uid);
    }

    // DISPENSARY TYPES
    match /dispensaryTypes/{typeId} {
      // Publicly readable for browsing.
      allow read: if true;
      // Only Super Admins can write.
      allow write: if isSuperAdmin(request.auth.uid);
    }
    
    // DISPENSARY TYPE PRODUCT CATEGORIES
    match /dispensaryTypeProductCategories/{docId} {
        // Anyone can read the category structures for building menus.
        allow read: if true;
        // Only Super Admins can write/edit category structures.
        allow write: if isSuperAdmin(request.auth.uid);
    }
    
    // PRODUCTS
    match /products/{productId} {
      // Anyone can read any product. Essential for public storefronts.
      allow get: if true;

      // Allow listing products if filtering by a specific dispensaryId (for public store pages)
      // OR if a dispensary admin is querying for their own products.
      allow list: if (request.query.where.path == "dispensaryId" && request.query.where.op == "==") || isSuperAdmin(request.auth.uid);
      
      // Only an admin of the product's dispensary can create, update, or delete it.
      // Super admins also have full write access.
      allow write: if isDispensaryAdmin(request.auth.uid, request.resource.data.dispensaryId) ||
                      isSuperAdmin(request.auth.uid);
    }

    // PRODUCT REQUESTS (POOL)
    match /productRequests/{requestId} {
      // Only involved parties (requester or owner) or a super admin can read.
      allow read: if isSuperAdmin(request.auth.uid) ||
                     isDispensaryAdmin(request.auth.uid, resource.data.requesterDispensaryId) ||
                     isDispensaryAdmin(request.auth.uid, resource.data.productOwnerDispensaryId);
      
      // The requester's admin can create.
      allow create: if isDispensaryAdmin(request.auth.uid, request.resource.data.requesterDispensaryId);
      
      // Involved parties can update (e.g., change status, add notes).
      allow update: if isSuperAdmin(request.auth.uid) ||
                       isDispensaryAdmin(request.auth.uid, resource.data.requesterDispensaryId) ||
                       isDispensaryAdmin(request.auth.uid, resource.data.productOwnerDispensaryId);
      
      // Only a super admin can delete.
      allow delete: if isSuperAdmin(request.auth.uid);
    }

    // POOL ISSUES
    match /poolIssues/{issueId} {
        // Super admins can read/write all issues.
        allow read, write: if isSuperAdmin(request.auth.uid);
        // Involved parties can create and read.
        allow create: if isDispensaryAdmin(request.auth.uid, request.resource.data.reporterDispensaryId);
        allow read: if isDispensaryAdmin(request.auth.uid, resource.data.reporterDispensaryId) ||
                       isDispensaryAdmin(request.auth.uid, resource.data.reportedDispensaryId);
    }
    
    // CREDIT PACKAGES
    match /creditPackages/{packageId} {
        // Publicly readable for purchase pages.
        allow read: if true;
        // Only super admins can write.
        allow write: if isSuperAdmin(request.auth.uid);
    }

    // STICKER SETS
    match /stickersets/{setId} {
      // Anyone can read public sets. Creator can read their own sets.
      allow read: if resource.data.isPublic == true || 
                     (request.auth != null && request.auth.uid == resource.data.creatorUid);
                     
      // Authenticated users can create sets.
      allow create: if request.auth != null && request.auth.uid == request.resource.data.creatorUid;
      
      // Only the creator can update/delete their own sets.
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.creatorUid;
    }
    
    // AI INTERACTIONS LOG
    match /aiInteractionsLog/{logId} {
        // A user can read their own logs.
        // A super admin can read all logs.
        allow read: if isSuperAdmin(request.auth.uid) ||
                       (request.auth != null && request.auth.uid == resource.data.userId);

        // Only backend functions can create logs.
        allow write: if false; 
    }
  }
}
