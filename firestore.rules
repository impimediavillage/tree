
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    function isDispensaryOwner() {
      return request.auth.token.role == 'DispensaryOwner';
    }

    function isDispensaryStaff() {
      return request.auth.token.role == 'DispensaryStaff';
    }

    function isOwnerOfDispensary(dispensaryId) {
      return isDispensaryOwner() && request.auth.token.dispensaryId == dispensaryId;
    }
    
    function isStaffOfDispensary(dispensaryId) {
      return isDispensaryStaff() && request.auth.token.dispensaryId == dispensaryId;
    }

    // Authenticated Users
    function isSignedIn() {
      return request.auth != null;
    }
    
    // PUBLIC COLLECTIONS
    match /dispensaryTypes/{typeId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }

    match /creditPackages/{packageId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }
    
    match /dispensaries/{dispensaryId} {
        allow read: if true; // Publicly viewable
        allow create: if isSignedIn();
        allow update: if isSuperAdmin() || isOwnerOfDispensary(dispensaryId);
        allow delete: if isSuperAdmin();
    }
    
     match /products/{productId} {
      allow read: if true;
      allow create: if isOwnerOfDispensary(resource.data.dispensaryId) || isStaffOfDispensary(resource.data.dispensaryId);
      allow update: if isOwnerOfDispensary(resource.data.dispensaryId) || isStaffOfDispensary(resource.data.dispensaryId) || isSuperAdmin();
      allow delete: if isOwnerOfDispensary(resource.data.dispensaryId) || isStaffOfDispensary(resource.data.dispensaryId) || isSuperAdmin();
    }

    // USER-SPECIFIC DATA
    match /users/{userId} {
      allow read, write: if request.auth.uid == userId || isSuperAdmin();
    }
    
    // STRAIN DATA
    match /my-seeded-collection/{strainId} {
        allow read: if true; // Allow public read access
        allow write: if isSuperAdmin(); // Only Super Admins can write
    }

    // All other collections/subcollections are locked down by default
    // Note: This rule will not match any paths that have been explicitly defined above.
    // E.g., /dispensaries/{dispensaryId}/products/{productId} is NOT matched by this.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
