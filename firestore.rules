{
  "rules": {
    "users": {
      // Users can read their own document
      "$uid": {
        "allow read": "request.auth.uid == $uid",
        "allow write": "request.auth.uid == $uid",
        // Super Admins can read/write any user document
        "allow read, write": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
      },
      // Super Admins can list users
      "allow list": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
    },
    "dispensaries": {
      // Anyone can read approved dispensaries
      "allow list, read": "true",
      // Super Admins can create/update/delete any dispensary
      "$dispensaryId": {
        "allow write, delete": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'",
        // Dispensary owners/staff can update their own dispensary
        "allow update": "request.auth.uid in get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId"
      }
    },
    "dispensaryTypes": {
      // Anyone can read dispensary types
      "allow list, read": "true",
      // Only Super Admins can create/update/delete types
      "$typeId": {
        "allow write, delete": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
      }
    },
    "products": {
      // Anyone can read products (for public storefronts)
      "allow read": "true",
      // Logged-in users can query products
      "allow list": "request.auth != null",
      // Dispensary owners/staff can write/delete products associated with their dispensary
      "$productId": {
        "allow write, delete": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.dispensaryId"
      }
    },
    "productRequests": {
      // Rules for product requests between dispensaries
      "$requestId": {
        "allow read, write, create": "request.auth != null && (request.auth.uid == resource.data.requesterUid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.productOwnerDispensaryId)",
        // Super Admins have full access
        "allow read, write, delete": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
      }
    },
    "poolIssues": {
      // Rules for reported issues in the product pool
      "$issueId": {
        // Involved parties can read
        "allow read": "request.auth != null && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.reporterDispensaryId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.reportedDispensaryId)",
        // Only involved parties can create/update
        "allow create, update": "request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.reporterDispensaryId",
         // Super Admins have full access
        "allow *": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
      }
    },
    "creditPackages": {
        "allow list, read": "true",
        "allow write, delete": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
    },
    "aiInteractionsLog": {
        "$logId": {
            "allow read": "request.auth.uid == resource.data.userId || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'",
            // Creation is handled by backend function
            "allow create": "request.auth != null"
        },
         "allow list": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
    },
    "stickersets": {
      // Anyone can read public sticker sets
      "allow read": "resource.data.isPublic == true",
      "allow list": "true", // Allow listing for public queries
      "$setId": {
         // Owner can read/write/delete their own sets
        "allow write, delete, read": "request.auth.uid == resource.data.creatorUid",
        // Super admin can do anything
        "allow *": "get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin'"
      }
    }
  }
}
