
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Default deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Users can read/write their own user document.
    // Admins have full access.
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId || request.auth.token.role == 'Super Admin';
      allow create: if request.auth.uid != null;
      allow list: if request.auth.token.role == 'Super Admin';
    }

    // Anyone can read public dispensary info. This is needed for store pages and the sharing feature.
    // Only Super Admins can create, update, or delete dispensaries.
    match /dispensaries/{dispensaryId} {
      allow read: if true;
      allow write: if request.auth.token.role == 'Super Admin';
    }

    // Dispensary Owners/Staff can manage products for their own dispensary.
    // Anyone can read products.
    match /products/{productId} {
      allow read: if true;
      allow create, update, delete: if request.auth.token.dispensaryId == resource.data.dispensaryId;
    }

    // Generic rule for other product collections (e.g., homeopathy_store_products)
    match /{collectionId}/{productId} {
        // Allows reading any product from any collection
        allow read: if true;
        // Allows writing only if the user is linked to the product's dispensary
        allow write: if request.auth.token.dispensaryId == request.resource.data.dispensaryId;
    }

    // Users can only interact with their own cart
    match /users/{userId}/cart/{cartItemId} {
        allow read, write, delete: if request.auth.uid == userId;
    }
    
    // Logged-in users can manage their own requests.
    // Owners can manage requests for their products.
    match /productRequests/{requestId} {
        allow read, create, update: if request.auth.uid != null && (request.auth.token.dispensaryId == resource.data.requesterDispensaryId || request.auth.token.dispensaryId == resource.data.productOwnerDispensaryId);
    }
    
    // Super Admins can manage all pool issues.
    match /poolIssues/{issueId} {
        allow read, write: if request.auth.token.role == 'Super Admin';
    }
    
    // AI interaction logs can only be created by the user themselves. Admins can read.
    match /aiInteractionsLog/{logId} {
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read: if request.auth.uid == resource.data.userId || request.auth.token.role == 'Super Admin';
    }

    // Dispensary types can be read by anyone, but only written by admins.
    match /dispensaryTypes/{typeId} {
        allow read: if true;
        allow write: if request.auth.token.role == 'Super Admin';
    }

    // Credit packages can be read by anyone, but only written by admins.
    match /creditPackages/{packageId} {
        allow read: if true;
        allow write: if request.auth.token.role == 'Super Admin';
    }
    
    // Seeded strain data is publicly readable.
    match /my-seeded-collection/{strainId} {
      allow read: if true;
    }
    
    // Sticker sets are publicly readable. Only creators can write.
    match /stickersets/{stickerId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.creatorUid;
      allow update, delete: if request.auth.uid == resource.data.creatorUid;
    }

    // Dispensary product categories are publicly readable, only admins can write.
    match /dispensaryTypeProductCategories/{docId} {
        allow read: if true;
        allow write: if request.auth.token.role == 'Super Admin';
    }
  }
}
