
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==== Default Security ====
    // By default, require users to be authenticated to read or write any data.
    match /{document=**} {
      allow read, write: if request.auth != null;
    }

    // ==== Users Collection ====
    // Public: anyone can create their own user document
    // User: can read and update their OWN document
    // Admin: can read and write ANY user document
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (request.auth.uid == userId || request.auth.token.role == 'Super Admin');
      allow delete: if request.auth != null && request.auth.token.role == 'Super Admin';
    }

    // ==== Dispensaries Collection ====
    // Public: anybody can read dispensary profiles (e.g., for store listings)
    // Authenticated: can create a new dispensary application
    // Admin: can update or delete any dispensary document
    match /dispensaries/{dispensaryId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.token.role == 'Super Admin';
    }

    // ==== Dispensary Types & Categories ====
    // Public: anyone can read these configuration documents
    // Admin: only Super Admins can modify these configurations
    match /dispensaryTypes/{typeId} {
        allow read: if true;
        allow write: if request.auth.token.role == 'Super Admin';
    }
    match /dispensaryTypeProductCategories/{docId} {
        allow read: if request.auth != null; // Authenticated users need to read this for product creation
        allow write: if request.auth.token.role == 'Super Admin';
    }

    // ==== Products Collections (using collection group) ====
    match /{path=**}/{productCollection}/{productId} {
      allow read: if true; // Public read access to all product collections
      allow create, update, delete: if request.auth != null 
          && (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff')
          && request.resource.data.dispensaryId == request.auth.token.dispensaryId;
    }

    // ==== Product Sharing Pool ====
    // A collection group query is used to browse the pool. This rule allows that query.
    match /{path=**}/products/{productId} {
       allow read, list: if request.auth != null && (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff');
    }

    // ==== Product Requests Collection ====
    // Users can create requests. 
    // Involved parties (requester or owner) can update (e.g., change status, add notes).
    // Admin can read/write everything.
    match /productRequests/{requestId} {
      allow read, update: if request.auth != null && 
                             (request.auth.token.role == 'Super Admin' ||
                              request.auth.token.dispensaryId == resource.data.requesterDispensaryId ||
                              request.auth.token.dispensaryId == resource.data.productOwnerDispensaryId);
      allow create: if request.auth != null && 
                     (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff') &&
                     request.resource.data.requesterDispensaryId == request.auth.token.dispensaryId;
    }

    // ==== Sticker Sets Collection ====
    match /stickersets/{setId} {
        allow read: if true; // Publicly readable
        allow create: if request.auth != null; // Any authenticated user can create
        allow update, delete: if request.auth != null && request.auth.uid == resource.data.creatorUid; // Only creator can edit/delete
    }

    // ==== Credit Packages Collection ====
    // Public: anyone can read active credit packages
    // Admin: only Super Admins can create/edit/delete packages
    match /creditPackages/{packageId} {
        allow read: if resource.data.isActive == true || request.auth.token.role == 'Super Admin';
        allow write: if request.auth.token.role == 'Super Admin';
    }
    
    // ==== AI Interaction Log Collection ====
    // Users can create their own logs.
    // Users can read their own logs.
    // Admins can read all logs.
    match /aiInteractionsLog/{logId} {
        allow create: if request.auth.uid == request.resource.data.userId;
        allow read: if request.auth.uid == resource.data.userId || request.auth.token.role == 'Super Admin';
        allow write: if request.auth.token.role == 'Super Admin'; // Only admin can update/delete
    }
  }
}
