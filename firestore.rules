rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ======== HELPER FUNCTIONS ========
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    function isDispensaryOwner(dispensaryId) {
      return request.auth.token.role == 'DispensaryOwner' && request.auth.token.dispensaryId == dispensaryId;
    }

    function isDispensaryStaff(dispensaryId) {
        return request.auth.token.role == 'DispensaryStaff' && request.auth.token.dispensaryId == dispensaryId;
    }

    function isOwnerOrStaff(dispensaryId) {
        return isDispensaryOwner(dispensaryId) || isDispensaryStaff(dispensaryId);
    }

    function isLeafUser() {
        return request.auth.token.role == 'LeafUser' || request.auth.token.role == 'User';
    }

    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwnerOfDoc(userId) {
        return request.auth.uid == userId;
    }


    // ======== GLOBAL RULES ========
    // Super Admins have universal read/write access. This is the master override.
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }


    // ======== COLLECTION-SPECIFIC RULES ========

    // --- Dispensaries ---
    match /dispensaries/{dispensaryId} {
        // Anyone can read an approved dispensary profile. Owners can read their own regardless of status.
        allow read: if resource.data.status == 'Approved' || isDispensaryOwner(dispensaryId);
        
        // Only owners can write to their own dispensary document.
        allow write: if isDispensaryOwner(dispensaryId);
    }
    
    // --- Users ---
    match /users/{userId} {
        // Users can read their own document. Owners/staff can read users linked to their dispensary.
        allow read: if isOwnerOfDoc(userId) || isOwnerOrStaff(resource.data.dispensaryId);
        
        // Users can only write to their own document.
        allow write: if isOwnerOfDoc(userId);
    }

    // --- Products ---
    match /products/{productId} {
      // Anyone can read a product from an approved dispensary.
      allow read: if get(/databases/$(database)/documents/dispensaries/$(resource.data.dispensaryId)).data.status == 'Approved';
      // Only owner/staff of the dispensary can create, update, delete products.
      allow write: if isOwnerOrStaff(request.resource.data.dispensaryId);
    }

    // --- Dispensary Types (Publicly Readable) ---
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if isSuperAdmin(); // Already covered by global rule, but explicit here.
    }
    
    // --- Product Categories (Publicly Readable) ---
    match /dispensaryTypeProductCategories/{docId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }

    // --- Credit Packages (Publicly Readable) ---
    match /creditPackages/{packageId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    
    // --- Sticker Sets ---
    match /stickersets/{setId} {
      allow read: if resource.data.isPublic == true;
      allow create: if isSignedIn();
      allow update, delete: if isOwnerOfDoc(resource.data.creatorUid);
    }

    // --- Product Requests ---
    match /productRequests/{requestId} {
        allow read, write: if isOwnerOrStaff(resource.data.productOwnerDispensaryId) || isOwnerOrStaff(resource.data.requesterDispensaryId);
        allow create: if isOwnerOrStaff(request.resource.data.requesterDispensaryId);
    }

    // --- Pool Issues ---
    match /poolIssues/{issueId} {
      allow read, write: if isOwnerOrStaff(resource.data.reporterDispensaryId) || isOwnerOrStaff(resource.data.reportedDispensaryId);
      allow create: if isOwnerOrStaff(request.resource.data.reporterDispensaryId);
    }

    // --- Notifications ---
    match /notifications/{notificationId} {
      allow read, write: if isOwnerOfDoc(resource.data.recipientUid);
    }

    // --- Logs (Write-only for functions) ---
    match /aiInteractionsLog/{logId} {
      allow read, write: if false; // No client access
    }
     match /scrapeLogs/{logId} {
      allow read: if isSignedIn();
      allow write: if false;
    }
     match /importsHistory/{historyId} {
      allow read: if isSuperAdmin();
      allow write: if false;
    }
    
    // --- Seed Data (Read-only for users) ---
    match /my-seeded-collection/{strainId} {
        allow read: if true;
        allow write: if false; // Should only be updated via backend function
    }
  }
}
