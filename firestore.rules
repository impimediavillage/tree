
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================================================
    //  MASTER RULE: Super Admins have universal read/write access.
    //  This rule is checked first and provides a "master key".
    // =================================================================
    match /{document=**} {
      allow read, write: if request.auth.token.role == 'Super Admin';
    }

    // =================================================================
    //  USER PROFILES (`/users/{userId}`)
    // =================================================================
    match /users/{userId} {
      // CREATE: Any authenticated user can create their own user document.
      allow create: if request.auth != null;

      // READ, UPDATE: A user can read or update their own document.
      // This is essential for the application to function after login.
      allow read, update: if request.auth.uid == userId;
    }

    // =================================================================
    //  DISPENSARIES (`/dispensaries/{dispensaryId}`)
    // =================================================================
    match /dispensaries/{dispensaryId} {
      // READ: Anyone can read approved dispensary profiles.
      allow read: if resource.data.status == 'Approved';

      // CREATE: Anyone can create a new dispensary application.
      allow create: if request.auth != null;

      // UPDATE: Only the owner of the dispensary can update it.
      allow update: if request.auth.uid == resource.data.ownerUid; 
    }

    // =================================================================
    //  PRODUCTS (`/products/{productId}`)
    // =================================================================
    match /products/{productId} {
      // READ: Anyone can read product information.
      allow read: true;
      
      // CREATE, UPDATE, DELETE: Only the owner of the associated dispensary can manage products.
      allow create, update, delete: if get(/databases/$(database)/documents/dispensaries/$(request.resource.data.dispensaryId)).data.ownerUid == request.auth.uid;
    }

    // =================================================================
    //  OTHER COLLECTIONS (Secure by default)
    //  These collections are only accessible via the Super Admin rule
    //  or by specific rules below if needed.
    // =================================================================
    match /dispensaryTypes/{typeId} {
      allow read: true;
    }
    
    match /creditPackages/{packageId} {
        allow read: if resource.data.isActive == true;
    }

    match /stickersets/{setId} {
        allow read: if resource.data.isPublic == true;
        allow create: if request.auth != null;
        allow update, delete: if request.auth.uid == resource.data.creatorUid;
    }
    
    match /productRequests/{requestId} {
      allow read, write: if request.auth != null; // Simplified for now, relies on backend logic.
    }
    
    match /poolIssues/{issueId} {
        allow read, write: if request.auth != null; // Simplified for now.
    }
    
    // Add other collection rules here as the app grows.
  }
}
