
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is an admin of a specific dispensary
    function isDispensaryAdmin(dispensaryId) {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == dispensaryId;
    }
    
    // Helper function to check if the user is a Super Admin
    function isSuperAdmin() {
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    match /users/{userId} {
      // A user can always read and update their own profile.
      allow read, update: if request.auth.uid == userId;

      // Super Admins can read/write any user document.
      allow read, write: if isSuperAdmin();

      // Dispensary Owners can read/list user documents that belong to their dispensary.
      allow read: if request.auth != null && resource.data.dispensaryId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId;
    }

    match /dispensaries/{dispensaryId} {
      // Anyone can read an approved dispensary profile (for public store pages)
      allow get: if resource.data.status == 'Approved';
      allow list: if request.query.get("status") == "Approved";

      // Super Admins have full access.
      allow read, write: if isSuperAdmin();
      
      // Dispensary Admins can read and update THEIR OWN dispensary document.
      allow read, update: if isDispensaryAdmin(dispensaryId);
    }

    match /dispensaryTypes/{typeId} {
      // All users can read the types of dispensaries available.
      allow read: if true;
      // Only Super Admins can create or change dispensary types.
      allow write: if isSuperAdmin();
    }
    
     match /dispensaryTypeProductCategories/{docId} {
      // Anyone can read product categories for display purposes
      allow read: if true;
      // Only Super Admins can write/edit category structures
      allow write: if isSuperAdmin();
    }

    match /products/{productId} {
      // Anyone can read any product. Essential for public storefronts.
      allow get, list: if true;

      // Dispensary Admins can create, update, and delete products in THEIR OWN dispensary.
      // Super Admins can write to any product.
      allow write: if isDispensaryAdmin(request.resource.data.dispensaryId) || isSuperAdmin();
    }
    
    match /productRequests/{requestId} {
      // A user can read a request if they are the owner or the requester.
      allow read: if isDispensaryAdmin(resource.data.productOwnerDispensaryId) || isDispensaryAdmin(resource.data.requesterDispensaryId);
      
      // A user can create a request if they are the requester.
      allow create: if isDispensaryAdmin(request.resource.data.requesterDispensaryId);
      
      // A user can update a request if they are part of the transaction.
      allow update: if isDispensaryAdmin(resource.data.productOwnerDispensaryId) || isDispensaryAdmin(resource.data.requesterDispensaryId);
      
      // Super admins can do anything.
      allow read, write: if isSuperAdmin();
    }

    match /poolIssues/{issueId} {
      // Involved parties and Super Admins can read/write.
      allow read, write: if isSuperAdmin() || isDispensaryAdmin(resource.data.reporterDispensaryId) || isDispensaryAdmin(resource.data.reportedDispensaryId);
      allow create: if isDispensaryAdmin(request.resource.data.reporterDispensaryId);
    }
    
    match /creditPackages/{packageId} {
        // Anyone can read active credit packages
        allow read: if resource.data.isActive == true;
        // Only Super Admins can write
        allow write: if isSuperAdmin();
    }
    
    match /aiInteractionsLog/{logId} {
        // A user can only access their own logs.
        allow read: if request.auth.uid == resource.data.userId;
        // The cloud function handles creation securely.
        allow create: if true; 
        allow list: if request.auth.uid == request.query.get("userId");
    }

    match /stickersets/{stickerId} {
        // Anyone can read a public sticker set. The creator can always read their own.
        allow read: if resource.data.isPublic == true || resource.data.creatorUid == request.auth.uid;
        // Only the creator can create or update/delete their own sticker sets.
        allow create: if request.resource.data.creatorUid == request.auth.uid;
        allow update, delete: if resource.data.creatorUid == request.auth.uid;
        // Super Admins can manage any sticker set.
        allow read, write: if isSuperAdmin();
    }
    
    // Default deny all other access
    match /{path=**} {
      allow read, write: if false;
    }
  }
}
