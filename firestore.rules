
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isSuperAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    function isDispensaryOwner(dispensaryId) {
      return request.auth.uid != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == dispensaryId;
    }

    match /users/{userId} {
      // Super Admins can read/write any user.
      allow read, write: if isSuperAdmin();

      // Users can read/write their own document.
      allow read, write: if request.auth.uid == userId;

      // A dispensary owner can list and read users belonging to their dispensary.
      allow list, get: if isDispensaryOwner(resource.data.dispensaryId);
    }
    
    match /dispensaries/{dispensaryId} {
        // Logged-in users can read approved dispensaries.
        allow get: if request.auth != null && resource.data.status == 'Approved';
        allow list: if request.auth != null;

        // Super admins can manage all dispensaries.
        allow read, write: if isSuperAdmin();
        
        // Dispensary owners can write to their own dispensary document.
        allow write: if isDispensaryOwner(dispensaryId);
    }
    
    match /dispensaryTypes/{typeId} {
        // Anyone can read the dispensary types.
        allow get, list: if true;
        
        // Only super admins can create/edit/delete them.
        allow write: if isSuperAdmin();
    }
    
    match /dispensaryTypeProductCategories/{docId} {
        // Anyone can read product categories.
        allow get, list: if true;
        // Only super admins can write them.
        allow write: if isSuperAdmin();
    }

    match /products/{productId} {
      // Allow read/get if user is super admin OR belongs to the product's dispensary
      allow get: if isSuperAdmin() || isDispensaryOwner(resource.data.dispensaryId);

      // Allow listing products ONLY if the query is filtered by the user's dispensaryId
      allow list: if isSuperAdmin() || (request.query.limit <= 100 && request.query.filters.size() > 0 && request.query.filters[0].field == 'dispensaryId' && request.query.filters[0].value == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId);
      
      // Allow writes if user is super admin OR belongs to the product's dispensary
      allow write: if isSuperAdmin() || isDispensaryOwner(request.resource.data.dispensaryId);
    }

    match /productRequests/{requestId} {
      // Users can only access requests where they are either the owner or the requester.
      allow read, write: if isDispensaryOwner(resource.data.productOwnerDispensaryId) || isDispensaryOwner(resource.data.requesterDispensaryId);
      allow create: if isDispensaryOwner(request.resource.data.requesterDispensaryId);
    }

    match /poolIssues/{issueId} {
        // Only Super Admins can read/write all pool issues.
        allow read, write: if isSuperAdmin();
        // Involved parties can also read the issue.
        allow get: if isDispensaryOwner(resource.data.reporterDispensaryId) || isDispensaryOwner(resource.data.reportedDispensaryId);
        // Any dispensary owner can create an issue.
        allow create: if request.auth.uid != null && request.resource.data.reporterDispensaryId == get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId;
    }

    match /aiInteractionsLog/{logId} {
        // Users can only read their own interaction logs.
        allow read: if request.auth.uid == resource.data.userId;
        // The cloud function backend creates the log with the user's UID.
        allow create: if request.auth.uid == request.resource.data.userId;
        // Super Admins can view any log for monitoring.
        allow list, get: if isSuperAdmin();
    }
    
    match /creditPackages/{packageId} {
        // Anyone can read active credit packages.
        allow get, list: if true;
        // Only Super Admins can create/edit/delete them.
        allow write: if isSuperAdmin();
    }
    
     match /stickersets/{stickerId} {
        // Anyone can read public sticker sets.
        allow get, list: if resource.data.isPublic == true;
        // Logged-in users can create sets.
        allow create: if request.auth.uid != null && request.auth.uid == request.resource.data.creatorUid;
        // Users can manage their own sets. SuperAdmins can manage any set.
        allow read, update, delete: if isSuperAdmin() || (request.auth.uid != null && request.auth.uid == resource.data.creatorUid);
    }
     match /importsHistory/{scrapeId} {
        allow read, write: if isSuperAdmin();
     }
  }
}
