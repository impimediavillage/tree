
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // =================================================================
    // Helper Functions
    // =================================================================
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    function isDispensaryOwner() {
      return request.auth.token.role == 'DispensaryOwner';
    }

    function isOwnerOfDispensary(dispensaryId) {
      return isDispensaryOwner() && request.auth.token.dispensaryId == dispensaryId;
    }
    
    function isOwnerOfDispensaryDoc(dispensaryDoc) {
      return request.auth.uid == dispensaryDoc.data.ownerId;
    }

    function isStaffOfDispensary(dispensaryId) {
      return request.auth.token.role == 'DispensaryStaff' && request.auth.token.dispensaryId == dispensaryId;
    }

    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // =================================================================
    // Global Admin Rule (Catch-all for safety)
    // =================================================================
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
    
    // =================================================================
    // Public & Authenticated Read Rules
    // =================================================================
    
    // Dispensary Types: Anyone can read these for filtering/display.
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    
    // Product Categories: Anyone can read these.
    match /dispensaryTypeProductCategories/{docId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }

    // Dispensaries: Public can see 'Approved' ones. Owners can read their own regardless of status.
    match /dispensaries/{dispensaryId} {
      allow read: if resource.data.status == 'Approved' || (isOwnerOfDispensary(dispensaryId) && isOwnerOfDispensaryDoc(resource));
      allow create: if isAuthenticated(); // For signup form
      allow update: if isOwnerOfDispensary(dispensaryId) && isOwnerOfDispensaryDoc(resource);
      allow delete: if isSuperAdmin(); // Prevent accidental deletion by owners
    }

    // Products: Public can read products of 'Approved' dispensaries.
    match /products/{productId} {
      allow read: if get(/databases/$(database)/documents/dispensaries/$(resource.data.dispensaryId)).data.status == 'Approved';
      allow create, update, delete: if isOwnerOfDispensary(request.resource.data.dispensaryId);
    }
    
    // Sticker Sets: Public can read if public.
    match /stickersets/{setId} {
        allow read: if resource.data.isPublic == true;
        allow create: if isAuthenticated();
        allow update, delete: if isUser(resource.data.creatorUid);
    }
    
    // Credit Packages: Logged-in users can read active packages.
    match /creditPackages/{packageId} {
      allow read: if isAuthenticated() && resource.data.isActive == true;
      allow write: if isSuperAdmin();
    }

    // =================================================================
    // User-Specific Rules
    // =================================================================

    // Users can read/write their own document. SuperAdmins can too.
    match /users/{userId} {
      allow read, update: if isUser(userId);
      allow create: if isAuthenticated();
      // Delete should likely only be handled by a Cloud Function for cleanup
      allow delete: if isSuperAdmin();
    }
    
    // Notifications: Only the recipient can access their notifications.
    match /notifications/{notificationId} {
        allow read, write: if isUser(resource.data.recipientUid);
    }
    
    // Product Requests: Only involved parties can access.
    match /productRequests/{requestId} {
        allow read, update: if isOwnerOfDispensary(resource.data.productOwnerDispensaryId) || isOwnerOfDispensary(resource.data.requesterDispensaryId);
        allow create: if isOwnerOfDispensary(request.resource.data.requesterDispensaryId);
    }
    
    // Pool Issues: Only involved parties and admins can access.
    match /poolIssues/{issueId} {
        allow read, update: if isOwnerOfDispensary(resource.data.reporterDispensaryId) || isOwnerOfDispensary(resource.data.reportedDispensaryId);
        allow create: if isOwnerOfDispensary(request.resource.data.reporterDispensaryId);
    }
    
    // AI Interaction Logs: Only the user who made them can see them.
    match /aiInteractionsLog/{logId} {
        allow read: if isUser(resource.data.userId);
        allow create: if isAuthenticated(); // Function will write this
    }
  }
}
