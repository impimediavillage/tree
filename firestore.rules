rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuth() && request.auth.uid == userId;
    }
    
    function isSuperAdmin() {
      return isAuth() && request.auth.token.role == 'Super Admin';
    }

    function isDispensaryOwner() {
      return isAuth() && request.auth.token.role == 'DispensaryOwner';
    }
    
    function isDispensaryStaff() {
      return isAuth() && request.auth.token.role == 'DispensaryStaff';
    }
    
    function isDispensaryMember() {
      return isDispensaryOwner() || isDispensaryStaff();
    }

    // Rules for 'users' collection
    match /users/{userId} {
      allow read: if isAuth();
      allow write: if isOwner(userId) || isSuperAdmin();
    }
    
    // Rules for 'dispensaries' collection
    match /dispensaries/{dispensaryId} {
      // Anyone can read approved dispensaries
      allow read: if resource.data.status == 'Approved';
      // Only signed-in users can apply (create)
      allow create: if isAuth();
      // Only Super Admins can update
      allow update: if isSuperAdmin();
      // Only Super Admins can delete
      allow delete: if isSuperAdmin();
    }

    // Rules for 'dispensaryTypes' collection
    match /dispensaryTypes/{typeId} {
        allow read: if true; // Anyone can read the available types
        allow write: if isSuperAdmin(); // Only SuperAdmins can create/update/delete types
    }
    
    // Rules for 'dispensaryTypeProductCategories'
    match /dispensaryTypeProductCategories/{docId} {
        allow read: if isAuth(); // Allow any authenticated user to read category structures
        allow write: if isSuperAdmin(); // Only super admins can modify these structures
    }

    // Rules for 'products' collection
    match /products/{productId} {
        allow read: if true; // Anyone can read product details
        allow create, update: if isDispensaryOwner() && request.resource.data.dispensaryId == request.auth.token.dispensaryId;
        allow delete: if isDispensaryOwner() && resource.data.dispensaryId == request.auth.token.dispensaryId || isSuperAdmin();
    }
    
    // Rules for product requests
    match /productRequests/{requestId} {
      allow read: if isDispensaryMember() && (resource.data.productOwnerDispensaryId == request.auth.token.dispensaryId || resource.data.requesterDispensaryId == request.auth.token.dispensaryId) || isSuperAdmin();
      allow create: if isDispensaryMember() && request.resource.data.requesterDispensaryId == request.auth.token.dispensaryId;
      allow update: if isDispensaryMember() && (resource.data.productOwnerDispensaryId == request.auth.token.dispensaryId || resource.data.requesterDispensaryId == request.auth.token.dispensaryId) || isSuperAdmin();
    }
    
    // Rules for pool issues
    match /poolIssues/{issueId} {
        allow read, update: if isSuperAdmin();
        allow create: if isDispensaryMember();
    }
    
     // Rules for credit packages
    match /creditPackages/{packageId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }
    
    // Rules for aiInteractionsLog
    match /aiInteractionsLog/{logId} {
        allow read: if isOwner(resource.data.userId) || isSuperAdmin();
        // Writes are handled by cloud functions
        allow write: if false; 
    }
    
    // Rules for notifications
    match /notifications/{notificationId} {
        allow read, update, delete: if isOwner(resource.data.recipientUid);
        // Writes are handled by cloud functions
        allow create: if false;
    }
    
    // Rules for the seeded strain data
    match /my-seeded-collection/{strainId} {
      allow read: if isAuth();
      allow write: if isSuperAdmin();
    }

    // Rules for sticker sets
    match /stickersets/{stickerId} {
      allow read: if resource.data.isPublic == true;
      allow create: if isAuth();
      allow update, delete: if isOwner(resource.data.creatorUid) || isSuperAdmin();
    }

    // --- COLLECTION GROUP RULES ---
    // These allow cross-collection queries to work as long as the conditions are met.
    
    match /{path=**}/dispensaries/{dispensaryId} {
      allow list: if isAuth(); // Allows queries across all dispensaries
    }
    
    match /{path=**}/products/{productId} {
        // Allow dispensary members to list products from their own store or all products in the pool
        allow list: if isDispensaryMember() || isSuperAdmin();
    }

    match /{path=**}/productRequests/{requestId} {
        // Allow owners to list requests related to them, and admins to list all
        allow list: if isDispensaryMember() || isSuperAdmin();
    }

    match /{path=**}/stickersets/{stickerId} {
      // Allow anyone to query for public sticker sets
      allow list: if true;
    }
    
    match /{path=**}/my-seeded-collection/{strainId} {
      // Allow any authenticated user to query the strain collection
      allow list: if isAuth();
    }
  }
}
