rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isDispensaryMember(dispensaryId) {
      return request.auth.token.dispensaryId == dispensaryId;
    }
  
    function isRole(role) {
      return request.auth.token.role == role;
    }

    // Allow Super Admins full read/write access to all collections
    match /{document=**} {
      allow read, write: if isRole('Super Admin');
    }

    // Users can read/update their own document
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create, delete: if isRole('Super Admin');
    }

    // Public read for approved dispensaries
    match /dispensaries/{dispensaryId} {
      allow read: if true; // Allow public read for all dispensaries
      allow update: if isDispensaryMember(dispensaryId) && (isRole('DispensaryOwner') || isRole('DispensaryStaff'));
      allow create, delete: if isRole('Super Admin');
    }

    // Allow read for AI Advisors
    match /aiAdvisors/{advisorId} {
        allow read: if true; // Public read
        allow write: if isRole('Super Admin');
    }

    // Allow read for dispensary types
    match /dispensaryTypes/{typeId} {
        allow read: if true;
    }
    
    // Allow read for product categories
    match /dispensaryTypeProductCategories/{docId} {
        allow read: if true;
    }
    
    // Allow read for active credit packages
    match /creditPackages/{packageId} {
        allow read: if resource.data.isActive == true;
    }

    // Rules for all product collections
    match /{collectionName=**_products}/{productId} {
        allow read: if true; // Publicly readable
        allow create, update: if isDispensaryMember(request.resource.data.dispensaryId);
        allow delete: if isDispensaryMember(resource.data.dispensaryId);
    }
    
    // Rules for product requests
    match /productRequests/{requestId} {
        allow create: if request.auth.uid != null;
        allow read, update: if isDispensaryMember(resource.data.productOwnerDispensaryId) || isDispensaryMember(resource.data.requesterDispensaryId);
    }
    
    // Rules for the new product pool orders collection
    match /productPoolOrders/{orderId} {
        allow create: if request.auth.uid != null;
        allow read: if isDispensaryMember(resource.data.productOwnerDispensaryId) || isDispensaryMember(resource.data.requesterDispensaryId);
    }
    
    // Rules for pool issues
    match /poolIssues/{issueId} {
        allow create: if request.auth.uid != null;
        allow read, update: if isDispensaryMember(resource.data.reporterDispensaryId) || isDispensaryMember(resource.data.reportedDispensaryId);
    }
    
    // Rules for sticker sets
    match /stickersets/{setId} {
        allow read: if resource.data.isPublic == true;
        allow create: if request.auth.uid != null;
        allow update, delete: if request.auth.uid == resource.data.creatorUid;
    }

    // Orders Collection
    match /orders/{orderId} {
      allow read: if request.auth.uid == resource.data.userId || isDispensaryMember(resource.data.dispensaryId);
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid == resource.data.userId || isDispensaryMember(resource.data.dispensaryId);
    }

    // Notifications Collection
    match /notifications/{notificationId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if true;
      allow update: if request.auth.uid == resource.data.userId;
    }

    // Notification Preferences
    match /notificationPreferences/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Reviews Collections
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid == resource.data.userId;
      allow delete: if isRole('Super Admin');
    }

    match /dispensaryReviews/{reviewId} {
      allow read: if true;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid == resource.data.userId;
      allow delete: if isRole('Super Admin');
    }

    match /dispensaryReviewStats/{dispensaryId} {
      allow read: if true;
      allow write: if false;
    }

    // Carts and Wishlists
    match /carts/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    match /wishlists/{userId} {
      allow read, write: if request.auth.uid == userId;
    }

    // Advisor Chats
    match /advisor_chats/{chatId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }

    // Events
    match /events/{eventId} {
      allow read: if true;
      allow create, update: if isDispensaryMember(request.resource.data.dispensaryId);
      allow delete: if isRole('Super Admin');
    }

    match /dispensaryEvents/{eventId} {
      allow read: if true;
      allow create, update: if isDispensaryMember(request.resource.data.dispensaryId);
      allow delete: if isRole('Super Admin');
    }

    // Educational Videos
    match /educationalVideos/{videoId} {
      allow read: if true;
      allow write: if isRole('Super Admin');
    }

    // Influencer System
    match /influencerProfiles/{profileId} {
      allow read: if true;
      allow create, update: if request.auth.uid == request.resource.data.userId;
      allow delete: if isRole('Super Admin');
    }

    match /referralClicks/{clickId} {
      allow create: if true;
      allow read: if request.auth.uid == resource.data.influencerId || isRole('Super Admin');
    }

    match /influencerCommissions/{commissionId} {
      allow read: if request.auth.uid == resource.data.influencerId || isRole('Super Admin');
      allow write: if false;
    }

    // AI Interactions Log
    match /aiInteractionsLog/{logId} {
      allow read: if request.auth.uid == resource.data.userId || isDispensaryMember(resource.data.dispensaryId);
      allow create: if request.auth.uid != null;
    }

    // Treehouse Collections
    match /treehouseProducts/{productId} {
      allow read: if true;
      allow create, update: if request.auth.uid == request.resource.data.creatorId;
      allow delete: if isRole('Super Admin');
    }

    match /creator_stores/{storeId} {
      allow read: if true;
      allow create: if request.auth.uid == request.resource.data.ownerId;
      allow update: if request.auth.uid == resource.data.ownerId;
      allow delete: if isRole('Super Admin');
    }

    match /creator_earnings/{userId} {
      allow read: if request.auth.uid == userId || isRole('Super Admin');
      allow write: if isRole('Super Admin');
    }

    match /earnings_transactions/{transactionId} {
      allow read: if request.auth.uid == resource.data.creatorId || isRole('Super Admin');
      allow write: if isRole('Super Admin');
    }

    match /treehouse_orders/{orderId} {
      allow read: if request.auth.uid == resource.data.buyerId || request.auth.uid == resource.data.creatorId;
      allow create: if request.auth.uid != null;
      allow update: if request.auth.uid == resource.data.creatorId;
    }

    match /creatorDesigns/{designId} {
      allow read: if request.auth.uid == resource.data.userId;
      allow create: if request.auth.uid == request.resource.data.userId;
      allow update: if request.auth.uid == resource.data.userId;
    }

    match /apparel_items/{itemId} {
      allow read: if true;
      allow write: if isRole('Super Admin');
    }

    // Dispensary Earnings & Payouts
    match /dispensary_earnings/{userId} {
      allow read: if request.auth.uid == userId || isDispensaryMember(resource.data.dispensaryId);
      allow write: if isRole('Super Admin');
    }

    match /dispensary_transactions/{transactionId} {
      allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
      allow write: if isRole('Super Admin');
    }

    match /dispensary_payout_requests/{requestId} {
      allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
      allow create: if isDispensaryMember(request.resource.data.dispensaryId);
      allow update: if isRole('Super Admin');
    }

    // Subcollections
    match /dispensaries/{dispensaryId}/scheduledShares/{shareId} {
      allow read, write: if isDispensaryMember(dispensaryId);
    }

    match /dispensaries/{dispensaryId}/shareAnalytics/{analyticsId} {
      allow read: if isDispensaryMember(dispensaryId);
      allow write: if true;
    }

    match /pricing_rules/{ruleId} {
      allow read: if true;
      allow write: if isRole('Super Admin');
    }

    match /payment_methods/{methodId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }

    match /shipping_addresses/{addressId} {
      allow read, write: if request.auth.uid == resource.data.userId;
    }

    // Driver System Collections
    match /driver_profiles/{driverId} {
        allow read: if request.auth.uid != null;
        allow create, update: if request.auth.uid == driverId || isRole('DispensaryOwner') || isRole('DispensaryStaff');
        allow delete: if isRole('Super Admin');
    }

    match /deliveries/{deliveryId} {
        allow read: if request.auth.uid != null;
        allow create: if isRole('DispensaryOwner') || isRole('DispensaryStaff');
        allow update: if request.auth.uid == resource.data.driverId || isDispensaryMember(resource.data.dispensaryId);
    }

    match /driver_notifications/{notificationId} {
        allow read: if request.auth.uid == resource.data.driverId;
        allow create: if true;
        allow update: if request.auth.uid == resource.data.driverId;
    }

    match /driver_payout_requests/{payoutId} {
        allow read: if request.auth.uid == resource.data.driverId || isDispensaryMember(resource.data.dispensaryId);
        allow create: if request.auth.uid == resource.data.driverId;
        allow update: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    // Advertising System Collections
    match /advertisements/{adId} {
        allow read: if true;
        allow create, update: if isDispensaryMember(request.resource.data.dispensaryId);
        allow delete: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /influencerAdSelections/{selectionId} {
        allow read: if request.auth.uid == resource.data.influencerId || isDispensaryMember(resource.data.dispensaryId);
        allow create: if request.auth.uid == request.resource.data.influencerId;
        allow update: if request.auth.uid == resource.data.influencerId || isDispensaryMember(resource.data.dispensaryId);
    }

    match /adImpressions/{impressionId} {
        allow create: if true;
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /adClicks/{clickId} {
        allow create: if true;
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /adConversions/{conversionId} {
        allow create: if true;
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /adDailyAnalytics/{analyticsId} {
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
        allow write: if false;
    }
  }
}
