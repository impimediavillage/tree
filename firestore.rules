rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isDispensaryOwnerOrStaff(dispensaryId) {
      return isSignedIn() && request.auth.token.dispensaryId == dispensaryId;
    }
    
    function isSuperAdmin() {
      return isSignedIn() && request.auth.token.role == 'Super Admin';
    }

    // PUBLIC ACCESS: Allow anyone to read public-facing data.
    match /dispensaryTypes/{typeId} {
      allow get: if true;
      allow list: if true;
    }
    
    match /dispensaries/{dispensaryId} {
      // Public can read approved dispensaries
      allow get: if resource.data.status == 'Approved';
      allow list: if resource.data.status == 'Approved'; // For queries
      
      // An authenticated user can read their own dispensary doc, regardless of status
      allow get: if isDispensaryOwnerOrStaff(dispensaryId);
    }
    
    match /products/{productId} {
      // Public can read products from approved dispensaries
      allow get: if get(/databases/$(database)/documents/dispensaries/$(resource.data.dispensaryId)).data.status == 'Approved';
      allow list: if true; // Allow queries, but secure them with rules on the collection group
    }
    
    match /creditPackages/{packageId} {
      allow get: if resource.data.isActive == true;
      allow list: if resource.data.isActive == true;
    }

    match /stickersets/{stickerId} {
        allow get: if resource.data.isPublic == true;
        allow list: if resource.data.isPublic == true;
    }

    // STRAIN DB: Allow anyone to read the strain database
    match /my-seeded-collection/{strainId} {
        allow read: if true;
    }

    // USER-SPECIFIC ACCESS
    match /users/{userId} {
      allow read, update: if isOwner(userId) || isSuperAdmin();
      allow create: if true; // Anyone can create a user doc (signup)
      allow list: if isSuperAdmin(); // Only super admins can list all users
    }

    match /users/{userId}/{document=**} {
      allow read, write: if isOwner(userId);
    }
    
    // AI Interaction Logs - users can only write to their own, and read their own.
    match /aiInteractionsLog/{logId} {
        allow create: if isSignedIn();
        allow read: if isOwner(request.resource.data.userId) || isDispensaryOwnerOrStaff(request.resource.data.dispensaryId);
        allow list: if isSignedIn(); // Queries will be filtered by user/dispensary id
    }

    // DISPENSARY ADMIN/STAFF ACCESS
    match /dispensaries/{dispensaryId} {
      // Owners/staff of a specific dispensary can update their own document
      allow update: if isDispensaryOwnerOrStaff(dispensaryId) || isSuperAdmin();
    }
    
    match /products/{productId} {
      // Allow create if user is part of a dispensary
      allow create: if isDispensaryOwnerOrStaff(request.resource.data.dispensaryId);
      // Allow update/delete if user is part of the dispensary that owns the product
      allow update, delete: if isDispensaryOwnerOrStaff(resource.data.dispensaryId) || isSuperAdmin();
    }
    
    match /productRequests/{requestId} {
      allow create: if isSignedIn();
      allow update: if isDispensaryOwnerOrStaff(resource.data.requesterDispensaryId) || isDispensaryOwnerOrStaff(resource.data.productOwnerDispensaryId) || isSuperAdmin();
    }
    
    // SUPER ADMIN ACCESS (broad access for management)
    match /{document=**} {
      allow read, write: if isSuperAdmin();
    }
  }
}
