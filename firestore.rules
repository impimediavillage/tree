rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper function to check if a user is a dispensary owner or staff
    function isDispensaryStaffOrOwner() {
      return request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff';
    }
    
    // Helper function to check if the user belongs to the dispensary associated with a resource
    function isOwnerOfDispensary(dispensaryId) {
      return request.auth.token.dispensaryId == dispensaryId;
    }

    // Rules for productPoolOrders
    match /productPoolOrders/{orderId} {
      // Only the product owner or the requester can read the order
      allow read: if isDispensaryStaffOrOwner() && 
                      (isOwnerOfDispensary(resource.data.productOwnerDispensaryId) || 
                       isOwnerOfDispensary(resource.data.requesterDispensaryId));
      
      // Only the requester's staff can create an order (as part of the final confirmation)
      allow create: if isDispensaryStaffOrOwner() && isOwnerOfDispensary(request.resource.data.requesterDispensaryId);
      
      // No one can update or delete finalized orders directly
      allow update, delete: if false;
    }

    // Creator Designs Collection
    match /creatorDesigns/{designId} {
      // Allow users to read their own designs
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Allow users to create their own designs (via API only)
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Allow users to update their own designs
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Super Admins can read all designs
      allow read: if request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Treehouse Products Collection
    match /treehouseProducts/{productId} {
      // Public read access for marketplace browsing
      allow read: if true;
      
      // Only creators can create/update their own products
      allow create, update: if request.auth != null && 
        (request.auth.uid == request.resource.data.creatorId || 
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin');
      
      // Super Admins can delete products
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Creator Stores Collection
    match /creator_stores/{storeId} {
      // Public read access for browsing creator stores
      allow read: if true;
      
      // Only authenticated users can create stores (one per user)
      allow create: if request.auth != null && 
        request.auth.uid == request.resource.data.ownerId &&
        (request.resource.data.userRole == 'LeafUser' || 
         request.resource.data.userRole == 'DispensaryOwner' || 
         request.resource.data.userRole == 'DispensaryStaff');
      
      // Only store owners can update their own stores
      allow update: if request.auth != null && 
        request.auth.uid == resource.data.ownerId;
      
      // Super Admins can delete stores
      allow delete: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Creator Earnings Collection
    match /creator_earnings/{userId} {
      // Creators can read their own earnings
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Super Admins can read all earnings
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // Only system/admins can write earnings (handled by backend/functions)
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Earnings Transactions Collection
    match /earnings_transactions/{transactionId} {
      // Creators can read their own transactions
      allow read: if request.auth != null && request.auth.uid == resource.data.creatorId;
      
      // Super Admins can read all transactions
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // Only system can write (handled by Cloud Functions)
      allow write: if false;
    }

    // Payout Requests Collection
    match /payout_requests/{requestId} {
      // Creators can read their own payout requests
      allow read: if request.auth != null && request.auth.uid == resource.data.creatorId;
      
      // Creators can create their own payout requests
      allow create: if request.auth != null && request.auth.uid == request.resource.data.creatorId;
      
      // Super Admins can read and update all payout requests
      allow read, update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // No deletes allowed
      allow delete: if false;
    }

    // Treehouse Orders Collection
    match /treehouse_orders/{orderId} {
      // Users can read their own orders
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Creators can read orders for their products
      allow read: if request.auth != null && request.auth.uid == resource.data.creatorId;
      
      // Super Admins can read and update all orders
      allow read, update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // Users can create orders (via checkout)
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // No direct deletes
      allow delete: if false;
    }

    // Orders Collection (extend existing rules)
    match /orders/{orderId} {
      // Users can read their own orders, creators can see their Treehouse orders, admins can see all
      allow read: if request.auth != null && 
        (request.auth.uid == resource.data.userId || 
         request.auth.uid == resource.data.creatorId ||
         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin');
      
      // Allow Super Admin to update POD status
      allow update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Apparel Items Collection (templates for Creator Lab)
    match /apparel_items/{itemId} {
      // Public read access for Creator Lab browsing
      allow read: if true;
      
      // Only Super Admins can write
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Treehouse Config Collection (origin locker, etc.)
    match /treehouse_config/{configId} {
      // Public read access for origin locker info
      allow read: if true;
      
      // Only Super Admins can write
      allow write: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
    }

    // Dispensary Earnings Collection
    match /dispensary_earnings/{userId} {
      // Staff can read their own earnings
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Dispensary admins can read all staff earnings from their dispensary
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'DispensaryOwner' &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.dispensaryId;
      
      // Super Admins can read all earnings
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // Only system/functions can write
      allow write: if false;
    }

    // Dispensary Transactions Collection
    match /dispensary_transactions/{transactionId} {
      // Staff can read their own transactions
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Dispensary admins can read all transactions from their dispensary
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'DispensaryOwner' &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.dispensaryId;
      
      // Super Admins can read all transactions
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // Only system can write (handled by Cloud Functions)
      allow write: if false;
    }

    // Dispensary Payout Requests Collection
    match /dispensary_payout_requests/{requestId} {
      // Staff can read their own payout requests
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Staff and admins can create payout requests
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Dispensary admins can read all requests from their dispensary
      allow read: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'DispensaryOwner' &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.dispensaryId;
      
      // Super Admins can read and update all payout requests
      allow read, update: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'SuperAdmin';
      
      // No deletes allowed
      allow delete: if false;
    }

    // ========================================
    // ADVERTISING SYSTEM RULES
    // ========================================
    
    // Advertisements Collection
    match /advertisements/{adId} {
      // Public read for active ads
      allow read: if resource.data.status == 'active' || 
                     (request.auth != null && isDispensaryStaffOrOwner() && 
                      isOwnerOfDispensary(resource.data.dispensaryId)) ||
                     (request.auth != null && request.auth.token.role == 'SuperAdmin');
      
      // Dispensary owners can create ads for their dispensary
      allow create: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(request.resource.data.dispensaryId) &&
                       request.resource.data.dispensaryId == request.auth.token.dispensaryId;
      
      // Dispensary owners can update their own ads
      allow update: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Dispensary owners can delete their own ads
      allow delete: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Super Admins have full access
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Influencer Ad Selections Collection
    match /influencerAdSelections/{selectionId} {
      // Influencers can read their own selections
      allow read: if request.auth != null && request.auth.uid == resource.data.influencerId;
      
      // Dispensary owners can read selections for their ads
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     exists(/databases/$(database)/documents/advertisements/$(resource.data.adId)) &&
                     isOwnerOfDispensary(get(/databases/$(database)/documents/advertisements/$(resource.data.adId)).data.dispensaryId);
      
      // Influencers can create selections (select ads to promote)
      allow create: if request.auth != null && 
                       request.resource.data.influencerId == request.auth.uid &&
                       exists(/databases/$(database)/documents/advertisements/$(request.resource.data.adId));
      
      // Influencers can update their own selections (pause/resume)
      allow update: if request.auth != null && request.auth.uid == resource.data.influencerId;
      
      // Super Admins have full access
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Ad Impressions Collection
    match /adImpressions/{impressionId} {
      // Anyone can create impressions (for tracking)
      allow create: if true;
      
      // Dispensary owners can read impressions for their ads
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     exists(/databases/$(database)/documents/advertisements/$(resource.data.adId)) &&
                     isOwnerOfDispensary(get(/databases/$(database)/documents/advertisements/$(resource.data.adId)).data.dispensaryId);
      
      // Influencers can read impressions for their tracking codes
      allow read: if request.auth != null && resource.data.influencerId == request.auth.uid;
      
      // Super Admins have full access
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Ad Clicks Collection
    match /adClicks/{clickId} {
      // Anyone can create clicks (for tracking)
      allow create: if true;
      
      // Dispensary owners can read clicks for their ads
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     exists(/databases/$(database)/documents/advertisements/$(resource.data.adId)) &&
                     isOwnerOfDispensary(get(/databases/$(database)/documents/advertisements/$(resource.data.adId)).data.dispensaryId);
      
      // Influencers can read clicks for their tracking codes
      allow read: if request.auth != null && resource.data.influencerId == request.auth.uid;
      
      // Super Admins have full access
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Ad Conversions Collection
    match /adConversions/{conversionId} {
      // Authenticated users can create conversions (from Cloud Functions)
      allow create: if request.auth != null;
      
      // Dispensary owners can read conversions for their ads
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     exists(/databases/$(database)/documents/advertisements/$(resource.data.adId)) &&
                     isOwnerOfDispensary(get(/databases/$(database)/documents/advertisements/$(resource.data.adId)).data.dispensaryId);
      
      // Influencers can read conversions for their tracking codes
      allow read: if request.auth != null && resource.data.influencerId == request.auth.uid;
      
      // Super Admins have full access
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Ad Daily Analytics Collection
    match /adDailyAnalytics/{analyticsId} {
      // Dispensary owners can read analytics for their ads
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     exists(/databases/$(database)/documents/advertisements/$(resource.data.adId)) &&
                     isOwnerOfDispensary(get(/databases/$(database)/documents/advertisements/$(resource.data.adId)).data.dispensaryId);
      
      // Super Admins have full access
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // ========================================
    // DRIVER MANAGEMENT SYSTEM RULES
    // ========================================
    
    // Driver Profiles Collection
    match /driver_profiles/{driverId} {
      // Drivers can read their own profile
      allow read: if request.auth != null && request.auth.uid == driverId;
      
      // Dispensary owners and staff can read drivers from their dispensary
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Dispensary owners and staff can write (create/update) driver profiles for their dispensary
      allow write: if request.auth != null && isDispensaryStaffOrOwner() && 
                      isOwnerOfDispensary(request.resource.data.dispensaryId);
      
      // Super Admins have full access
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Deliveries Collection
    match /deliveries/{deliveryId} {
      // Drivers can read deliveries from their dispensary (for browsing available deliveries)
      allow read: if request.auth != null;
      
      // Dispensary owners and staff can create deliveries
      allow create: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(request.resource.data.dispensaryId);
      
      // Drivers can update deliveries they've claimed (for status updates)
      allow update: if request.auth != null && request.auth.uid == resource.data.driverId;
      
      // Dispensary owners and staff can update deliveries from their dispensary
      allow update: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Super Admins have full access
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Driver Notifications Collection
    match /driver_notifications/{notificationId} {
      // Drivers can read their own notifications
      allow read: if request.auth != null && request.auth.uid == resource.data.driverId;
      
      // Drivers can update (mark as read) their own notifications
      allow update: if request.auth != null && request.auth.uid == resource.data.driverId &&
                       resource.data.driverId == request.resource.data.driverId;
      
      // Only Cloud Functions can create/delete notifications
      allow create, delete: if false;
      
      // Super Admins can read all
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Driver Payout Requests Collection
    match /driver_payout_requests/{payoutId} {
      // Drivers can read their own payout requests
      allow read: if request.auth != null && request.auth.uid == resource.data.driverId;
      
      // Drivers can create their own payout requests
      allow create: if request.auth != null && request.auth.uid == request.resource.data.driverId;
      
      // Dispensary owners can read payout requests from their dispensary
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Dispensary owners can update (approve/reject) payout requests from their dispensary
      allow update: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Super Admins have full access
      allow read, update: if request.auth != null && request.auth.token.role == 'SuperAdmin';
      
      // No deletes allowed
      allow delete: if false;
    }

    // ========================================
    // CORE COLLECTIONS
    // ========================================
    
    // Dispensaries Collection (PUBLIC BROWSING)
    match /dispensaries/{dispensaryId} {
      // Public read access for browsing
      allow read: if true;
      
      // Dispensary owners can update their own dispensary
      allow update: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(dispensaryId);
      
      // Super Admins can create/update/delete
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Dispensary Types Collection (PUBLIC BROWSING)
    match /dispensaryTypes/{typeId} {
      // Public read access for browsing
      allow read: if true;
      
      // Only Super Admins can write
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Products Collection (PUBLIC BROWSING)
    match /products/{productId} {
      // Public read access for browsing
      allow read: if true;
      
      // Dispensary owners and staff can create/update products for their dispensary
      allow create, update: if request.auth != null && isDispensaryStaffOrOwner() && 
                               isOwnerOfDispensary(request.resource.data.dispensaryId);
      
      // Super Admins can delete
      allow delete: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // AI Advisors Collection (PUBLIC BROWSING)
    match /aiAdvisors/{advisorId} {
      // Public read access for browsing advisors
      allow read: if true;
      
      // Only Super Admins can write
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Users Collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // Users can update their own data
      allow update: if request.auth != null && request.auth.uid == userId;
      
      // Super Admins can read all users
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
      
      // Dispensary owners can read their staff
      allow read: if request.auth != null && isDispensaryStaffOrOwner() && 
                     isOwnerOfDispensary(resource.data.dispensaryId);
    }
    
    // Orders Collection
    match /orders/{orderId} {
      // Users can read their own orders
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Users can create orders
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Users can update their own orders (for cancellations, etc.)
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Dispensary owners and staff can read orders for their dispensary
      allow read, update: if request.auth != null && isDispensaryStaffOrOwner() && 
                             (request.resource.data.shipments[request.auth.token.dispensaryId] != null ||
                              resource.data.shipments[request.auth.token.dispensaryId] != null);
      
      // Super Admins have full access
      allow read, write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Notifications Collection
    match /notifications/{notificationId} {
      // Users can read their own notifications
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Users can update (mark as read) their own notifications
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Cloud Functions can create notifications
      allow create: if true;
      
      // Super Admins have full access
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Reviews Collection
    match /reviews/{reviewId} {
      // Public read access
      allow read: if true;
      
      // Authenticated users can create reviews
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      
      // Users can update their own reviews
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Super Admins can delete
      allow delete: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Dispensary Review Stats Collection
    match /dispensaryReviewStats/{dispensaryId} {
      // Public read access
      allow read: if true;
      
      // Only Cloud Functions can write
      allow write: if false;
    }
    
    // Cart Collection
    match /carts/{userId} {
      // Users can read/write their own cart
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Wishlist Collection
    match /wishlists/{userId} {
      // Users can read/write their own wishlist
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // Advisor Chats Collection
    match /advisor_chats/{chatId} {
      // Users can read/write their own chats
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
      
      // Super Admins can read all chats
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Events Collection
    match /events/{eventId} {
      // Public read access
      allow read: if true;
      
      // Dispensary owners can create events for their dispensary
      allow create: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(request.resource.data.dispensaryId);
      
      // Dispensary owners can update their own events
      allow update: if request.auth != null && isDispensaryStaffOrOwner() && 
                       isOwnerOfDispensary(resource.data.dispensaryId);
      
      // Super Admins have full access
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Sticker Sets Collection
    match /stickersets/{setId} {
      // Public read access
      allow read: if true;
      
      // Users can create their own sticker sets
      allow create: if request.auth != null && request.auth.uid == request.resource.data.creatorId;
      
      // Users can update their own sets
      allow update: if request.auth != null && request.auth.uid == resource.data.creatorId;
      
      // Super Admins have full access
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Pricing Rules Collection
    match /pricing_rules/{ruleId} {
      // Public read access for pricing calculations
      allow read: if true;
      
      // Only Super Admins can write
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }
    
    // Payment Methods Collection
    match /payment_methods/{methodId} {
      // Users can read/write their own payment methods
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }
    
    // Shipping Addresses Collection
    match /shipping_addresses/{addressId} {
      // Users can read/write their own addresses
      allow read, write: if request.auth != null && request.auth.uid == resource.data.userId;
    }

    // Notification Preferences Collection
    match /notificationPreferences/{userId} {
      // Users can read/write their own preferences
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Dispensary Reviews Collection  
    match /dispensaryReviews/{reviewId} {
      // Public read access
      allow read: if true;
      // Authenticated users can create reviews
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Users can update their own reviews
      allow update: if request.auth != null && request.auth.uid == resource.data.userId;
      // Super Admins can delete
      allow delete: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // Credit Packages Collection (PUBLIC BROWSING)
    match /creditPackages/{packageId} {
      // Public read access for pricing page
      allow read: if true;
      // Only Super Admins can write
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // Educational Videos Collection (PUBLIC BROWSING)
    match /educationalVideos/{videoId} {
      // Public read access
      allow read: if true;
      // Only Super Admins can write
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // Influencer Profiles Collection
    match /influencerProfiles/{profileId} {
      // Public read access for browsing
      allow read: if true;
      // Users can create/update their own profile
      allow create, update: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Super Admins can manage all
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // Referral Clicks Collection
    match /referralClicks/{clickId} {
      // Public write for tracking clicks
      allow create: if true;
      // Only owner and admins can read
      allow read: if request.auth != null && 
                     (request.auth.uid == resource.data.influencerId || 
                      request.auth.token.role == 'SuperAdmin');
    }

    // Influencer Commissions Collection
    match /influencerCommissions/{commissionId} {
      // Influencers can read their own commissions
      allow read: if request.auth != null && request.auth.uid == resource.data.influencerId;
      // Super Admins can read all
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
      // Only system can write
      allow write: if false;
    }

    // Dispensary Events Collection
    match /dispensaryEvents/{eventId} {
      // Public read access
      allow read: if true;
      // Dispensary staff can create/update their own events
      allow create, update: if request.auth != null && isDispensaryStaffOrOwner() &&
                               isOwnerOfDispensary(request.resource.data.dispensaryId);
      // Super Admins can delete
      allow delete: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // Dispensary Type Product Categories Collection
    match /dispensaryTypeProductCategories/{categoryId} {
      // Public read access
      allow read: if true;
      // Only Super Admins can write
      allow write: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // AI Interactions Log Collection
    match /aiInteractionsLog/{logId} {
      // Users can read their own logs
      allow read: if request.auth != null && request.auth.uid == resource.data.userId;
      // Users can create logs
      allow create: if request.auth != null && request.auth.uid == request.resource.data.userId;
      // Dispensary staff can read logs for their dispensary
      allow read: if request.auth != null && isDispensaryStaffOrOwner() &&
                     isOwnerOfDispensary(resource.data.dispensaryId);
      // Super Admins can read all
      allow read: if request.auth != null && request.auth.token.role == 'SuperAdmin';
    }

    // Scheduled Shares Subcollection
    match /dispensaries/{dispensaryId}/scheduledShares/{shareId} {
      // Dispensary staff can manage their own scheduled shares
      allow read, write: if request.auth != null && isDispensaryStaffOrOwner() &&
                            isOwnerOfDispensary(dispensaryId);
    }

    // Share Analytics Subcollection
    match /dispensaries/{dispensaryId}/shareAnalytics/{analyticsId} {
      // Dispensary staff can read their own analytics
      allow read: if request.auth != null && isDispensaryStaffOrOwner() &&
                     isOwnerOfDispensary(dispensaryId);
      // System can write
      allow write: if true;
    }
  }
}
