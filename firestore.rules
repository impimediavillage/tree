rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSuperAdmin() {
      return request.auth.token.role == 'Super Admin';
    }

    function isDispensaryOwner(dispensaryId) {
      return request.auth != null && request.auth.token.dispensaryId == dispensaryId;
    }

    // Authenticated Users
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if the user is the owner of the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // USERS
    match /users/{userId} {
      allow read: if isOwner(userId) || isSuperAdmin();
      allow write: if isOwner(userId) || isSuperAdmin();
    }
    
    // DISPENSARY APPLICATIONS & PROFILES
    match /dispensaries/{dispensaryId} {
      allow read: if resource.data.status == 'Approved' || isOwner(resource.data.ownerUid) || isDispensaryOwner(dispensaryId) || isSuperAdmin();
      allow create: if true; // Anyone can submit an application
      allow update: if isDispensaryOwner(dispensaryId) || isSuperAdmin();
      allow delete: if isSuperAdmin();
    }

    // PRODUCTS
    match /products/{productId} {
      allow read: if true; // Anyone can see products
      allow create: if (isDispensaryOwner(request.resource.data.dispensaryId) || isSuperAdmin());
      allow update: if (isDispensaryOwner(resource.data.dispensaryId) || isSuperAdmin());
      allow delete: if (isDispensaryOwner(resource.data.dispensaryId) || isSuperAdmin());
    }
    
    // PRODUCT REQUESTS (POOL)
    match /productRequests/{requestId} {
      allow read: if isAuthenticated() && (isDispensaryOwner(resource.data.requesterDispensaryId) || isDispensaryOwner(resource.data.productOwnerDispensaryId) || isSuperAdmin());
      allow create: if isAuthenticated() && isDispensaryOwner(request.resource.data.requesterDispensaryId);
      allow update: if isAuthenticated() && (isDispensaryOwner(resource.data.requesterDispensaryId) || isDispensaryOwner(resource.data.productOwnerDispensaryId) || isSuperAdmin());
      allow delete: if isSuperAdmin();
    }
    
    // POOL ISSUES
    match /poolIssues/{issueId} {
      allow read: if isAuthenticated(); // Owners involved and admins can read
      allow create: if isAuthenticated(); // Only authenticated dispensary owners can create
      allow update: if isSuperAdmin(); // Only admins can update status/resolution
      allow delete: if isSuperAdmin();
    }
    
    // DISPENSARY TYPES (PUBLIC CONFIG)
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if isSuperAdmin();
    }
    
    // CATEGORIES (PUBLIC CONFIG)
    match /dispensaryTypeProductCategories/{docId} {
      allow read: if isAuthenticated();
      allow write: if isSuperAdmin();
    }
    
    // CREDIT PACKAGES (PUBLIC CONFIG)
    match /creditPackages/{packageId} {
        allow read: if true; // Everyone can see packages
        allow write: if isSuperAdmin(); // Only admin can create/edit
    }
    
    // AI INTERACTION LOGS
    match /aiInteractionsLog/{logId} {
        allow read, write: if isSuperAdmin(); // Admin can review
        allow create: if isAuthenticated(); // Any auth user can have a log created for them
    }

    // NOTIFICATIONS
    match /notifications/{notificationId} {
      allow read, update, delete: if isOwner(resource.data.recipientUid) || isSuperAdmin();
      allow create: if isAuthenticated(); // Functions create these
    }

    // STICKER SETS
    match /stickersets/{setId} {
      allow read: if true;
      allow create: if isOwner(request.resource.data.creatorUid);
      allow update, delete: if isOwner(resource.data.creatorUid) || isSuperAdmin();
    }

    // --- Seed Data & Scrape Logs ---
    match /my-seeded-collection/{docId} {
        allow read: if true; // Publicly readable for strain lookups
        allow write: if isSuperAdmin(); // Only admin can modify/seed
    }
    match /justbrand_catalog/{docId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }
    match /justbrand_catalog/{docId}/products/{productId} {
        allow read: if true;
        allow write: if isSuperAdmin();
    }
    match /scrapeLogs/{logId} {
      allow read, write: if isSuperAdmin();
    }
    match /importsHistory/{logId} {
      allow read, write: if isSuperAdmin();
    }
  }
}