rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if a user has a specific role
    function isRole(role) {
      return request.auth.token.role == role;
    }
    
    // Helper function to check if the user is the owner of a document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to get dispensaryId from user's custom claims
    function userDispensaryId() {
      return request.auth.token.dispensaryId;
    }

    // Users collection:
    // - Authenticated users can read their own profile.
    // - Super Admins can read/write any user profile.
    // - Users can create their own profile upon signup.
    match /users/{userId} {
      allow read: if isOwner(userId) || isRole('Super Admin');
      allow write: if isOwner(userId) || isRole('Super Admin');
      allow create: if request.auth != null;
    }
    
    // Dispensaries collection:
    // - Super Admins can read/write any dispensary document.
    // - Authenticated users who are owners of a dispensary can read their own document.
    // - Anyone can create a dispensary application.
    match /dispensaries/{dispensaryId} {
        allow read: if isRole('Super Admin') || (isRole('DispensaryOwner') && userDispensaryId() == dispensaryId);
        allow write: if isRole('Super Admin');
        allow create: if request.auth != null;
    }
    
    // Products collection:
    // - Authenticated users can read any product (for public store viewing).
    // - Dispensary Owners can create, update, and delete products ONLY for their own dispensary.
    // - Super Admins can read/write any product.
    match /products/{productId} {
      allow read: if request.auth != null;
      allow create, update, delete: if isRole('Super Admin') || (isRole('DispensaryOwner') && request.resource.data.dispensaryId == userDispensaryId());
    }
    
    // Dispensary Types & Categories:
    // - Anyone can read the types and their category structures.
    // - Only Super Admins can create or modify them.
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if isRole('Super Admin');
    }
    match /dispensaryTypeProductCategories/{docId} {
      allow read: if true;
      allow write: if isRole('Super Admin');
    }
    
    // Credit Packages:
    // - Anyone can read active credit packages.
    // - Only Super Admins can create or modify them.
    match /creditPackages/{packageId} {
        allow read: if resource.data.isActive == true || isRole('Super Admin');
        allow write: if isRole('Super Admin');
    }
    
    // Product Requests:
    // - Only the involved parties (requester or owner) or a Super Admin can read/write.
    match /productRequests/{requestId} {
        allow read, write: if isRole('Super Admin') || 
                            (isRole('DispensaryOwner') && (request.resource.data.requesterDispensaryId == userDispensaryId() || request.resource.data.productOwnerDispensaryId == userDispensaryId()));
    }

    // Default deny for all other collections unless explicitly allowed.
    // This includes collections like `aiInteractionsLog`, `poolIssues`, `notifications`, etc.
    // which are only written to by secure Cloud Functions.
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
