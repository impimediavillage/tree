rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // PUBLIC-FACING DATA
    // Anyone can read dispensary types and approved dispensaries
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if request.auth.token.role == 'Super Admin';
    }
    match /dispensaries/{dispensaryId} {
        allow read: if resource.data.status == 'Approved';
        allow create: if request.auth != null; // User must be logged in to apply
        allow update, delete: if request.auth.token.role == 'Super Admin';
    }
    // Anyone can search strains.
    match /my-seeded-collection/{strainId} {
      allow read: if true;
      allow write: if request.auth.token.role == 'Super Admin';
    }

    // USER DATA
    match /users/{userId} {
      // Users can only read and update their own profile
      allow read, update: if request.auth.uid == userId;
      // Super Admins can read and write to any user profile
      allow read, write: if request.auth.token.role == 'Super Admin';
      // Allow user creation
      allow create: if request.auth.uid == userId;
    }

    // CREDIT & PAYMENT DATA
    match /creditPackages/{packageId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.role == 'Super Admin';
    }
     match /aiInteractionsLog/{logId} {
      allow create: if request.auth.uid == request.resource.data.userId;
      allow read: if request.auth.uid == resource.data.userId || request.auth.token.role == 'Super Admin';
    }

    // All product collections should end with `_products`.
    // This allows for dynamic collection names based on dispensary type.
    match /{productCollection}/{productId}
      where productCollection.endsWith('_products') {
        // Logged-in users can read products from any type-specific product collection
        allow read: if request.auth != null;
        
        // Only dispensary staff/owners can write to their own products.
        // Super Admins have full access.
        allow write: if request.auth.token.dispensaryId == request.resource.data.dispensaryId
                      || request.auth.token.role == 'Super Admin';
    }


    // PRODUCT REQUEST & POOL DATA
    match /productRequests/{requestId} {
        allow create: if request.auth.token.dispensaryId == request.resource.data.requesterDispensaryId;
        allow read, update: if request.auth.token.dispensaryId == resource.data.requesterDispensaryId
                            || request.auth.token.dispensaryId == resource.data.productOwnerDispensaryId
                            || request.auth.token.role == 'Super Admin';
    }

    match /poolIssues/{issueId} {
        allow create: if request.auth.token.dispensaryId == request.resource.data.reporterDispensaryId;
        allow read, update: if request.auth.token.dispensaryId == resource.data.reporterDispensaryId
                            || request.auth.token.dispensaryId == resource.data.reportedDispensaryId
                            || request.auth.token.role == 'Super Admin';
    }
    
    // Sticker Sets
    match /stickersets/{setId} {
        allow read: if true;
        allow create: if request.auth.uid == request.resource.data.creatorUid;
        allow update, delete: if resource.data.creatorUid == request.auth.uid || request.auth.token.role == 'Super Admin';
    }
  }
}
