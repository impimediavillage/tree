rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    match /users/{userId} {
      // Users can read/write their own profile
      allow read, write: if request.auth.uid == userId;
      
      // Admins can manage users within their own dispensary
      allow list: if request.auth.uid != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role in ['DispensaryOwner', 'Super Admin'] &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == request.query.where.dispensaryId;
    }

    match /products/{productId} {
      // Anyone can read a single product document (for public store pages)
      allow get: if true;

      // Admins can list products belonging to their dispensary
      // This is the key rule that fixes the /dispensary-admin/products page
      allow list: if request.auth.uid != null &&
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == request.query.where.dispensaryId;

      // Admins can write products only for their own dispensary
      allow write: if request.auth.uid != null &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == request.resource.data.dispensaryId;
    }

    match /dispensaries/{dispensaryId} {
      // Anyone can read dispensary info (for public store pages)
      allow get: if true;
      allow list: if true;

      // Only Super Admins should be able to write to dispensaries
      allow write: if request.auth.uid != null &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    match /dispensaryTypes/{typeId} {
      // Publicly readable
      allow get, list: if true;
      // Only Super Admins can write
      allow write: if request.auth.uid != null &&
                    get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }
    
    match /dispensaryTypeProductCategories/{docId} {
        allow get, list: if true;
        allow write: if request.auth.uid != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }
    
    match /productRequests/{requestId} {
      allow read, write: if request.auth.uid != null; // Simplified for now, can be tightened later
    }
    
    match /poolIssues/{issueId} {
      allow read, write: if request.auth.uid != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    match /aiInteractionsLog/{logId} {
       allow read, create: if request.auth.uid != null && request.auth.uid == request.resource.data.userId;
    }
    
    match /creditPackages/{packageId} {
        allow get, list: if true;
        allow create, write: if request.auth.uid != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }

    match /stickersets/{stickerId} {
        allow get, list: if true;
        allow create, write, delete: if request.auth.uid != null && request.resource.data.creatorUid == request.auth.uid;
    }
    
    match /importsHistory/{docId} {
        allow get, list: if request.auth.uid != null &&
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Super Admin';
    }
  }
}