rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to get user's role and dispensaryId from their profile
    function getUserData(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    // Helper function to check for Super Admin role
    function isSuperAdmin(userId) {
      return getUserData(userId).role == 'Super Admin';
    }

    // Helper function to check for Dispensary Owner/Staff role
    function isDispensaryAdmin(userId) {
      let role = getUserData(userId).role;
      return role == 'DispensaryOwner' || role == 'DispensaryStaff';
    }

    // Helper function to check if a user belongs to a specific dispensary
    function isOwnerOfDispensary(userId, dispensaryId) {
      return getUserData(userId).dispensaryId == dispensaryId;
    }

    // Users Collection
    match /users/{userId} {
      // Allow users to read/update their own profile
      allow read, update: if request.auth.uid == userId;

      // Super Admins can read/write any user profile
      allow read, list, write: if isSuperAdmin(request.auth.uid);

      // Dispensary Admins can list users belonging to their own dispensary
      allow list: if isDispensaryAdmin(request.auth.uid) &&
                     request.query.where.dispensaryId == getUserData(request.auth.uid).dispensaryId;
    }

    // Dispensaries Collection
    match /dispensaries/{dispensaryId} {
      // Allow public read for approved dispensaries
      allow get: if resource.data.status == 'Approved';
      allow list: if request.query.where.status == 'Approved';

      // Allow owner to read their own dispensary document regardless of status
      allow read: if request.auth != null && isOwnerOfDispensary(request.auth.uid, dispensaryId);
      
      // Super Admins have full access
      allow read, list, write: if request.auth != null && isSuperAdmin(request.auth.uid);

      // Dispensary owners can update their own dispensary
      allow update: if request.auth != null && isOwnerOfDispensary(request.auth.uid, dispensaryId);
    }
    
    // DispensaryTypes Collection
    match /dispensaryTypes/{typeId} {
        // Public can read all types
        allow read: if true;
    }

    // DispensaryTypeProductCategories Collection
    match /dispensaryTypeProductCategories/{docId} {
        // Public can read all category structures
        allow read: if true;
        // Only Super Admins can write
        allow write: if request.auth != null && isSuperAdmin(request.auth.uid);
    }

    // Products Collection
    match /products/{productId} {
        // Allow public to read/list products
        allow read: if true;
        
        // Allow writes only by the owning dispensary admin/staff
        allow write: if request.auth != null && isOwnerOfDispensary(request.auth.uid, request.resource.data.dispensaryId);
    }

    // ProductRequests Collection
    match /productRequests/{requestId} {
      allow read, write: if request.auth != null && 
                          (isOwnerOfDispensary(request.auth.uid, resource.data.productOwnerDispensaryId) ||
                           isOwnerOfDispensary(request.auth.uid, resource.data.requesterDispensaryId) ||
                           isSuperAdmin(request.auth.uid));
    }
    
    // All other collections: Default deny, but can be specified
    match /{document=**} {
      allow read, write: if request.auth != null && isSuperAdmin(request.auth.uid);
    }
  }
}
