rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    function isDispensaryMember(dispensaryId) {
      return request.auth.token.dispensaryId == dispensaryId;
    }
  
    function isRole(role) {
      return request.auth.token.role == role;
    }

    // Allow Super Admins full read/write access to all collections
    match /{document=**} {
      allow read, write: if isRole('Super Admin');
    }

    // Users can read/update their own document
    match /users/{userId} {
      allow read, update: if request.auth.uid == userId;
      allow create, delete: if isRole('Super Admin');
    }

    // Public read for approved dispensaries
    match /dispensaries/{dispensaryId} {
      allow read: if resource.data.status == 'Approved';
      allow update: if isDispensaryMember(dispensaryId) && (isRole('DispensaryOwner') || isRole('DispensaryStaff'));
      allow create, delete: if isRole('Super Admin');
    }

    // Allow read for dispensary types
    match /dispensaryTypes/{typeId} {
        allow read: if true;
    }
    
    // Allow read for product categories
    match /dispensaryTypeProductCategories/{docId} {
        allow read: if true;
    }
    
    // Allow read for active credit packages
    match /creditPackages/{packageId} {
        allow read: if resource.data.isActive == true;
    }

    // Rules for all product collections
    match /{collectionName=**_products}/{productId} {
        allow read: if true; // Publicly readable
        allow create, update: if isDispensaryMember(request.resource.data.dispensaryId);
        allow delete: if isDispensaryMember(resource.data.dispensaryId);
    }
    
    // Rules for product requests
    match /productRequests/{requestId} {
        allow create: if request.auth.uid != null;
        allow read, update: if isDispensaryMember(resource.data.productOwnerDispensaryId) || isDispensaryMember(resource.data.requesterDispensaryId);
    }
    
    // Rules for the new product pool orders collection
    match /productPoolOrders/{orderId} {
        allow create: if request.auth.uid != null;
        allow read: if isDispensaryMember(resource.data.productOwnerDispensaryId) || isDispensaryMember(resource.data.requesterDispensaryId);
    }
    
    // Rules for pool issues
    match /poolIssues/{issueId} {
        allow create: if request.auth.uid != null;
        allow read, update: if isDispensaryMember(resource.data.reporterDispensaryId) || isDispensaryMember(resource.data.reportedDispensaryId);
    }
    
    // Rules for sticker sets
    match /stickersets/{setId} {
        allow read: if resource.data.isPublic == true;
        allow create: if request.auth.uid != null;
        allow update, delete: if request.auth.uid == resource.data.creatorUid;
    }

    // Driver System Collections
    match /driver_profiles/{driverId} {
        allow read: if request.auth.uid != null;
        allow create, update: if request.auth.uid == driverId || isRole('DispensaryOwner') || isRole('DispensaryStaff');
        allow delete: if isRole('Super Admin');
    }

    match /deliveries/{deliveryId} {
        allow read: if request.auth.uid != null;
        allow create: if isRole('DispensaryOwner') || isRole('DispensaryStaff');
        allow update: if request.auth.uid == resource.data.driverId || isDispensaryMember(resource.data.dispensaryId);
    }

    match /driver_notifications/{notificationId} {
        allow read: if request.auth.uid == resource.data.driverId;
        allow create: if true;
        allow update: if request.auth.uid == resource.data.driverId;
    }

    match /driver_payout_requests/{payoutId} {
        allow read: if request.auth.uid == resource.data.driverId || isDispensaryMember(resource.data.dispensaryId);
        allow create: if request.auth.uid == resource.data.driverId;
        allow update: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    // Advertising System Collections
    match /advertisements/{adId} {
        allow read: if true;
        allow create, update: if isDispensaryMember(request.resource.data.dispensaryId);
        allow delete: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /influencerAdSelections/{selectionId} {
        allow read: if request.auth.uid == resource.data.influencerId || isDispensaryMember(resource.data.dispensaryId);
        allow create: if request.auth.uid == request.resource.data.influencerId;
        allow update: if request.auth.uid == resource.data.influencerId || isDispensaryMember(resource.data.dispensaryId);
    }

    match /adImpressions/{impressionId} {
        allow create: if true;
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /adClicks/{clickId} {
        allow create: if true;
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }

    match /adConversions/{conversionId} {
        allow create: if true;
        allow read: if isDispensaryMember(resource.data.dispensaryId) || isRole('Super Admin');
    }
  }
}
