rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    function isSuperAdmin() {
      return request.auth != null && request.auth.token.role == 'Super Admin';
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // Global rule: Super Admins can read/write anything
    match /{path=**} {
      allow read, write: if isSuperAdmin();
    }
    
    // Public read rules
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if isSuperAdmin(); // Explicitly for super admin to manage
    }

    match /dispensaries/{dispensaryId} {
      // Anyone can read an approved dispensary profile
      allow read: if resource.data.status == 'Approved';
      // Anyone can submit a dispensary application
      allow create: if isSignedIn();
      // Only super admin can modify dispensary documents
      allow update, delete: if isSuperAdmin();
    }

    match /products/{productId} {
      // Anyone can read any product
      allow read: if true;
      // Write access is more complex, might depend on dispensary ownership
      // Let's allow owners or staff to write to their own products.
      allow write: if isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.dispensaryId;
    }

    match /stickersets/{stickerId} {
        // Anyone can read a public sticker set
        allow read: if resource.data.isPublic == true;
        // Only the creator can read their own private sets
        allow read: if isSignedIn() && resource.data.creatorUid == request.auth.uid;
        // Logged-in users can create sets
        allow create: if isSignedIn();
        // Only the creator can update or delete their own sets
        allow update, delete: if isSignedIn() && resource.data.creatorUid == request.auth.uid;
    }

    // User data rules
    match /users/{userId} {
      // A user can read/write to their own document
      allow read, update: if isOwner(userId);
      // Allow user creation during signup
      allow create: if isSignedIn();
    }
    
    // Public read for credit packages
    match /creditPackages/{packageId} {
        allow read: if true;
        // Only admins can change packages
        allow write: if isSuperAdmin();
    }

    // Notifications: Only the recipient can read/update their notifications
    match /notifications/{notificationId} {
      allow read, update, delete: if isSignedIn() && resource.data.recipientUid == request.auth.uid;
    }

    // Product Requests
    match /productRequests/{requestId} {
      allow create: if isSignedIn();
      // Requester or owner can read/update
      allow read, update: if isSignedIn() && (request.auth.uid == resource.data.requesterUid || request.auth.uid == resource.data.productOwnerUid);
    }
    
     // Seeded Strain Data & Scraper Catalogs - allow read for all signed in users
    match /my-seeded-collection/{strainId} {
      allow read: if isSignedIn();
      allow write: if isSuperAdmin(); // Allow admins to update image URLs etc.
    }
    match /justbrand_catalog/{docId} {
        allow read: if true;
    }
     match /justbrand_catalog/{docId}/{subcollection}/{subDocId} {
        allow read: if true;
    }
  }
}
