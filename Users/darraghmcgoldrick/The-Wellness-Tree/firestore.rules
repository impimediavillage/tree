
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Default Deny: No one can read/write data unless a rule explicitly allows it.
    match /{document=**} {
      allow read, write: if false;
    }

    // Users Collection
    // - A user can read and write to their own document.
    // - A Super Admin can read and write to any user document.
    // - A dispensary owner can read data of users linked to their dispensary.
    match /users/{userId} {
      allow read: if request.auth.uid == userId 
                    || request.auth.token.role == 'Super Admin'
                    || (request.auth.token.role == 'DispensaryOwner' && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.dispensaryId == resource.data.dispensaryId);
      allow update: if request.auth.uid == userId 
                     || request.auth.token.role == 'Super Admin';
      allow create: if request.auth.uid == userId;
    }

    // Dispensaries Collection
    // - Anyone can read approved dispensaries.
    // - Owners can update their own dispensary.
    // - Super Admins can read/write any dispensary.
    match /dispensaries/{dispensaryId} {
      allow read: if resource.data.status == 'Approved' 
                   || request.auth.token.dispensaryId == dispensaryId
                   || request.auth.token.role == 'Super Admin';
      allow create: if request.auth != null; // Allow creation for any authenticated user (signup form)
      allow update: if request.auth.token.dispensaryId == dispensaryId
                     || request.auth.token.role == 'Super Admin';
      allow delete: if request.auth.token.role == 'Super Admin';
    }
    
    // Dispensary Types & Categories
    // - Anyone can read these as they are needed for public UI.
    // - Only Super Admins can write to them.
    match /dispensaryTypes/{typeId} {
      allow read: if true;
      allow write: if request.auth.token.role == 'Super Admin';
    }
    match /dispensaryTypeProductCategories/{docId} {
      allow read: if true;
      allow write: if request.auth.token.role == 'Super Admin';
    }

    // Products Collection
    // - Anyone can read products.
    // - Dispensary Owners/Staff can manage products for their own dispensary.
    // - Super Admins have full access.
    match /products/{productId} {
      allow read: if true;
      allow create: if request.auth.token.dispensaryId == request.resource.data.dispensaryId
                     && (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff');
      allow update: if get(/databases/$(database)/documents/products/$(productId)).data.dispensaryId == request.auth.token.dispensaryId
                     && (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff');
      allow delete: if get(/databases/$(database)/documents/products/$(productId)).data.dispensaryId == request.auth.token.dispensaryId
                     && (request.auth.token.role == 'DispensaryOwner' || request.auth.token.role == 'DispensaryStaff')
                     || request.auth.token.role == 'Super Admin';
    }

    // Credit Packages
    // - Anyone can read active packages.
    // - Only Super Admins can write.
    match /creditPackages/{packageId} {
        allow read: if resource.data.isActive == true;
        allow write: if request.auth.token.role == 'Super Admin';
    }
    
    // Sticker Sets
    // - Anyone can read public sticker sets.
    // - Owners can manage their own sets.
    match /stickersets/{setId} {
        allow read: if resource.data.isPublic == true;
        allow create: if request.auth.uid == request.resource.data.creatorUid;
        allow update, delete: if request.auth.uid == resource.data.creatorUid;
    }

    // AI Interaction Logs, Requests, Pool Issues
    // - These should generally only be accessible by the involved parties or admins.
    match /aiInteractionsLog/{logId} {
      allow read: if request.auth.uid == resource.data.userId 
                   || request.auth.token.role == 'Super Admin'
                   || (request.auth.token.dispensaryId != null && request.auth.token.dispensaryId == resource.data.dispensaryId);
      allow create: if request.auth.uid == request.resource.data.userId;
    }

    match /productRequests/{requestId} {
      allow read, update: if request.auth.token.dispensaryId == resource.data.requesterDispensaryId
                        || request.auth.token.dispensaryId == resource.data.productOwnerDispensaryId
                        || request.auth.token.role == 'Super Admin';
      allow create: if request.auth.token.dispensaryId == request.resource.data.requesterDispensaryId;
    }

    match /poolIssues/{issueId} {
        allow read, update: if request.auth.token.role == 'Super Admin';
        allow create: if request.auth.token.dispensaryId == request.resource.data.reporterDispensaryId;
    }
    
    // Scraper history, internal use
    match /importsHistory/{logId} {
        allow read, write: if request.auth.token.role == 'Super Admin';
    }
    
    // Seeded data (read-only for clients)
    match /my-seeded-collection/{docId} {
        allow read: if true;
        allow write: if request.auth.token.role == 'Super Admin'; // Only admins can modify
    }
  }
}
